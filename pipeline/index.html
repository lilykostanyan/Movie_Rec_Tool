
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
      
        <link rel="prev" href="..">
      
      
        <link rel="next" href="../etl/">
      
      
      <link rel="icon" href="../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.6.1, mkdocs-material-9.6.13">
    
    
      
        <title>PIPELINE - My Docs</title>
      
    
    
      <link rel="stylesheet" href="../assets/stylesheets/main.342714a4.min.css">
      
        
        <link rel="stylesheet" href="../assets/stylesheets/palette.06af60db.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
      <link rel="stylesheet" href="../assets/_mkdocstrings.css">
    
    <script>__md_scope=new URL("..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
    
  </head>
  
  
    
    
      
    
    
    
    
    <body dir="ltr" data-md-color-scheme="default" data-md-color-primary="amber" data-md-color-accent="purple">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#-data-pipeline" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

<header class="md-header" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href=".." title="My Docs" class="md-header__button md-logo" aria-label="My Docs" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            My Docs
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              PIPELINE
            
          </span>
        </div>
      </div>
    </div>
    
      
        <form class="md-header__option" data-md-component="palette">
  
    
    
    
    <input class="md-option" data-md-color-media="" data-md-color-scheme="default" data-md-color-primary="amber" data-md-color-accent="purple"  aria-label="Switch to dark mode"  type="radio" name="__palette" id="__palette_0">
    
      <label class="md-header__button md-icon" title="Switch to dark mode" for="__palette_1" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M17 6H7c-3.31 0-6 2.69-6 6s2.69 6 6 6h10c3.31 0 6-2.69 6-6s-2.69-6-6-6m0 10H7c-2.21 0-4-1.79-4-4s1.79-4 4-4h10c2.21 0 4 1.79 4 4s-1.79 4-4 4M7 9c-1.66 0-3 1.34-3 3s1.34 3 3 3 3-1.34 3-3-1.34-3-3-3"/></svg>
      </label>
    
  
    
    
    
    <input class="md-option" data-md-color-media="" data-md-color-scheme="slate" data-md-color-primary="amber" data-md-color-accent="lime"  aria-label="Switch to light mode"  type="radio" name="__palette" id="__palette_1">
    
      <label class="md-header__button md-icon" title="Switch to light mode" for="__palette_0" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M17 7H7a5 5 0 0 0-5 5 5 5 0 0 0 5 5h10a5 5 0 0 0 5-5 5 5 0 0 0-5-5m0 8a3 3 0 0 1-3-3 3 3 0 0 1 3-3 3 3 0 0 1 3 3 3 3 0 0 1-3 3"/></svg>
      </label>
    
  
</form>
      
    
    
      <script>var palette=__md_get("__palette");if(palette&&palette.color){if("(prefers-color-scheme)"===palette.color.media){var media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']");palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent")}for(var[key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script>
    
    
    
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
            
<nav class="md-tabs" aria-label="Tabs" data-md-component="tabs">
  <div class="md-grid">
    <ul class="md-tabs__list">
      
        
  
  
  
  
    <li class="md-tabs__item">
      <a href=".." class="md-tabs__link">
        
  
  
    
  
  Home

      </a>
    </li>
  

      
        
  
  
  
    
  
  
    <li class="md-tabs__item md-tabs__item--active">
      <a href="./" class="md-tabs__link">
        
  
  
    
  
  PIPELINE

      </a>
    </li>
  

      
        
  
  
  
  
    <li class="md-tabs__item">
      <a href="../etl/" class="md-tabs__link">
        
  
  
    
  
  ETL

      </a>
    </li>
  

      
        
  
  
  
  
    <li class="md-tabs__item">
      <a href="../back/" class="md-tabs__link">
        
  
  
    
  
  BACK

      </a>
    </li>
  

      
        
  
  
  
  
    <li class="md-tabs__item">
      <a href="../front/" class="md-tabs__link">
        
  
  
    
  
  FRONT

      </a>
    </li>
  

      
    </ul>
  </div>
</nav>
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    


  


  

<nav class="md-nav md-nav--primary md-nav--lifted md-nav--integrated" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href=".." title="My Docs" class="md-nav__button md-logo" aria-label="My Docs" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    My Docs
  </label>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href=".." class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Home
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
    
  
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          
  
  
  <span class="md-ellipsis">
    PIPELINE
    
  </span>
  

          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        
  
  
  <span class="md-ellipsis">
    PIPELINE
    
  </span>
  

      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#-workflow" class="md-nav__link">
    <span class="md-ellipsis">
      - Workflow
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#-main-pipeline" class="md-nav__link">
    <span class="md-ellipsis">
      - Main Pipeline
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#app.pipeline.main_pipeline" class="md-nav__link">
    <span class="md-ellipsis">
      main_pipeline
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#app.pipeline.main_pipeline.run_pipeline" class="md-nav__link">
    <span class="md-ellipsis">
      run_pipeline()
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#-submodules" class="md-nav__link">
    <span class="md-ellipsis">
      - Submodules
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#app.pipeline.scrape_tt_codes" class="md-nav__link">
    <span class="md-ellipsis">
      scrape_tt_codes
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#app.pipeline.scrape_tt_codes.extract_tt_codes" class="md-nav__link">
    <span class="md-ellipsis">
      extract_tt_codes()
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#app.pipeline.scrape_tt_codes.run_scraper" class="md-nav__link">
    <span class="md-ellipsis">
      run_scraper()
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#app.pipeline.scrape_tt_codes.scrape_imdb_movie_codes" class="md-nav__link">
    <span class="md-ellipsis">
      scrape_imdb_movie_codes()
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#app.pipeline.extract_movie_data" class="md-nav__link">
    <span class="md-ellipsis">
      extract_movie_data
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#app.pipeline.extract_movie_data.IMDbCrawler" class="md-nav__link">
    <span class="md-ellipsis">
      IMDbCrawler
    </span>
  </a>
  
    <nav class="md-nav" aria-label="IMDbCrawler">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#app.pipeline.extract_movie_data.IMDbCrawler.crawl_movies" class="md-nav__link">
    <span class="md-ellipsis">
      crawl_movies()
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#app.pipeline.extract_movie_data.IMDbCrawler.extract_movie_data" class="md-nav__link">
    <span class="md-ellipsis">
      extract_movie_data()
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#app.pipeline.extract_movie_data.IMDbCrawler.get_movies_from_tsv" class="md-nav__link">
    <span class="md-ellipsis">
      get_movies_from_tsv()
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#app.pipeline.extract_movie_data.IMDbCrawler.init_session" class="md-nav__link">
    <span class="md-ellipsis">
      init_session()
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#app.pipeline.extract_movie_data.IMDbCrawler.record_processed_id" class="md-nav__link">
    <span class="md-ellipsis">
      record_processed_id()
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#app.pipeline.extract_movie_data.run_crawler" class="md-nav__link">
    <span class="md-ellipsis">
      run_crawler()
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#app.pipeline.clean_synopsis" class="md-nav__link">
    <span class="md-ellipsis">
      clean_synopsis
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#app.pipeline.clean_synopsis.clean_romance_synopsis" class="md-nav__link">
    <span class="md-ellipsis">
      clean_romance_synopsis()
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#app.pipeline.split_movie_data" class="md-nav__link">
    <span class="md-ellipsis">
      split_movie_data
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#app.pipeline.split_movie_data.split_movie_xlsx" class="md-nav__link">
    <span class="md-ellipsis">
      split_movie_xlsx()
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#app.pipeline.drive_upload" class="md-nav__link">
    <span class="md-ellipsis">
      drive_upload
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#app.pipeline.drive_upload.upload_metadata_to_drive" class="md-nav__link">
    <span class="md-ellipsis">
      upload_metadata_to_drive()
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#app.pipeline.bigquery_upload" class="md-nav__link">
    <span class="md-ellipsis">
      bigquery_upload
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#app.pipeline.bigquery_upload.upload_single_file_to_bigquery" class="md-nav__link">
    <span class="md-ellipsis">
      upload_single_file_to_bigquery()
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#app.pipeline.chunk_and_embed" class="md-nav__link">
    <span class="md-ellipsis">
      chunk_and_embed
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#app.pipeline.chunk_and_embed.run_chunk_and_embed_pipeline" class="md-nav__link">
    <span class="md-ellipsis">
      run_chunk_and_embed_pipeline()
    </span>
  </a>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../etl/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    ETL
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../back/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    BACK
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../front/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    FRONT
    
  </span>
  

      </a>
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  



<h1 id="-data-pipeline">- Data Pipeline</h1>
<p>The pipeline automates the full process of <strong>collecting</strong>, <strong>processing</strong>, and <strong>uploading</strong> movie data into a vector search engine (Elasticsearch) and cloud storage (Google BigQuery). This pipeline ensures scalable and efficient ingestion of new movie data for recommendation.</p>
<hr />
<h2 id="-workflow">- Workflow</h2>
<ol>
<li>
<p><strong>TT Code Scraping</strong><br />
   Uses Playwright to extract unique IMDb <code>tt</code> codes from genre-based search results. Simulates user scrolling and clicking "Show More" to dynamically load more movie IDs.</p>
</li>
<li>
<p><strong>Metadata &amp; Synopsis Extraction</strong><br />
   Asynchronously visits movie and plot pages using <code>aiohttp</code> + <code>BeautifulSoup</code>, extracting:</p>
</li>
<li>Title, year, duration, rating, genres</li>
<li>
<p>Short synopsis, long synopsis, and user summaries</p>
</li>
<li>
<p><strong>Data Cleaning</strong><br />
   Removes rows with no narrative text and cleans extra characters, usernames, and unnecessary suffixes.</p>
</li>
<li>
<p><strong>Data Splitting</strong>  </p>
</li>
<li><strong>Metadata File</strong>: structured movie info  </li>
<li>
<p><strong>Synopsis File</strong>: cleaned narrative texts, labeled by type (<code>short</code>, <code>long</code>, <code>summary</code>)</p>
</li>
<li>
<p><strong>Cloud Upload</strong><br />
   Metadata is uploaded to <strong>Google Drive</strong> via API, then ingested into <strong>Google BigQuery</strong>.</p>
</li>
<li>
<p><strong>Chunking &amp; Embedding</strong><br />
   Synopsis text is chunked (~250 words) and embedded with <strong>SBERT</strong> into dense vectors using <code>SentenceTransformer</code>.</p>
</li>
<li>
<p><strong>Output Generation</strong><br />
   Each chunk + vector is saved as a <code>.json</code> file and archived into a ZIP for ingestion.</p>
</li>
<li>
<p><strong>ETL Trigger</strong><br />
   The ZIP is moved to <code>etl/data/jsons/</code>, where <code>run_etl.sh</code> automatically unzips and indexes all files into <strong>Elasticsearch</strong>.</p>
</li>
</ol>
<hr />
<h2 id="-main-pipeline">- Main Pipeline</h2>


<div class="doc doc-object doc-module">



<a id="app.pipeline.main_pipeline"></a>
  <div class="doc doc-contents first">

  

  <div class="doc doc-children">










<div class="doc doc-object doc-function">




<h2 id="app.pipeline.main_pipeline.run_pipeline" class="doc doc-heading">
          <code class="highlight language-python"><span class="n">run_pipeline</span><span class="p">()</span></code>

</h2>


  <div class="doc doc-contents ">
  
      <p>Executes the main pipeline for processing IMDb movie data. The pipeline consists of the following steps:
1. Scrape IMDb tt codes.
2. Scrape movie metadata and synopsis.
3. Split combined CSV into metadata and synopsis files.
4. Upload metadata to Google Drive.
5. Upload metadata from Google Drive to BigQuery.
6. Clean synopsis data.
7. Chunk and embed synopsis data.
8. Move the resulting ZIP file to the <code>etl/data/jsons/</code> directory.</p>

          <details class="quote">
            <summary>Source code in <code>app/pipeline/main_pipeline.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 20</span>
<span class="normal"> 21</span>
<span class="normal"> 22</span>
<span class="normal"> 23</span>
<span class="normal"> 24</span>
<span class="normal"> 25</span>
<span class="normal"> 26</span>
<span class="normal"> 27</span>
<span class="normal"> 28</span>
<span class="normal"> 29</span>
<span class="normal"> 30</span>
<span class="normal"> 31</span>
<span class="normal"> 32</span>
<span class="normal"> 33</span>
<span class="normal"> 34</span>
<span class="normal"> 35</span>
<span class="normal"> 36</span>
<span class="normal"> 37</span>
<span class="normal"> 38</span>
<span class="normal"> 39</span>
<span class="normal"> 40</span>
<span class="normal"> 41</span>
<span class="normal"> 42</span>
<span class="normal"> 43</span>
<span class="normal"> 44</span>
<span class="normal"> 45</span>
<span class="normal"> 46</span>
<span class="normal"> 47</span>
<span class="normal"> 48</span>
<span class="normal"> 49</span>
<span class="normal"> 50</span>
<span class="normal"> 51</span>
<span class="normal"> 52</span>
<span class="normal"> 53</span>
<span class="normal"> 54</span>
<span class="normal"> 55</span>
<span class="normal"> 56</span>
<span class="normal"> 57</span>
<span class="normal"> 58</span>
<span class="normal"> 59</span>
<span class="normal"> 60</span>
<span class="normal"> 61</span>
<span class="normal"> 62</span>
<span class="normal"> 63</span>
<span class="normal"> 64</span>
<span class="normal"> 65</span>
<span class="normal"> 66</span>
<span class="normal"> 67</span>
<span class="normal"> 68</span>
<span class="normal"> 69</span>
<span class="normal"> 70</span>
<span class="normal"> 71</span>
<span class="normal"> 72</span>
<span class="normal"> 73</span>
<span class="normal"> 74</span>
<span class="normal"> 75</span>
<span class="normal"> 76</span>
<span class="normal"> 77</span>
<span class="normal"> 78</span>
<span class="normal"> 79</span>
<span class="normal"> 80</span>
<span class="normal"> 81</span>
<span class="normal"> 82</span>
<span class="normal"> 83</span>
<span class="normal"> 84</span>
<span class="normal"> 85</span>
<span class="normal"> 86</span>
<span class="normal"> 87</span>
<span class="normal"> 88</span>
<span class="normal"> 89</span>
<span class="normal"> 90</span>
<span class="normal"> 91</span>
<span class="normal"> 92</span>
<span class="normal"> 93</span>
<span class="normal"> 94</span>
<span class="normal"> 95</span>
<span class="normal"> 96</span>
<span class="normal"> 97</span>
<span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span>
<span class="normal">102</span>
<span class="normal">103</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">run_pipeline</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Executes the main pipeline for processing IMDb movie data. The pipeline consists of the following steps:</span>
<span class="sd">    1. Scrape IMDb tt codes.</span>
<span class="sd">    2. Scrape movie metadata and synopsis.</span>
<span class="sd">    3. Split combined CSV into metadata and synopsis files.</span>
<span class="sd">    4. Upload metadata to Google Drive.</span>
<span class="sd">    5. Upload metadata from Google Drive to BigQuery.</span>
<span class="sd">    6. Clean synopsis data.</span>
<span class="sd">    7. Chunk and embed synopsis data.</span>
<span class="sd">    8. Move the resulting ZIP file to the `etl/data/jsons/` directory.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Step 1: Scrape tt codes</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;- Step 1: Scraping tt codes from IMDb...&quot;</span><span class="p">)</span>
    <span class="n">run_scraper</span><span class="p">()</span>

    <span class="c1"># Step 2: Scrape movie metadata and synopsis</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;- Step 2: Scraping movie metadata and synopsis...&quot;</span><span class="p">)</span>
    <span class="n">asyncio</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">run_crawler</span><span class="p">(</span>
        <span class="n">output_dir</span><span class="o">=</span><span class="s2">&quot;imdb_data&quot;</span><span class="p">,</span>
        <span class="n">num_movies</span><span class="o">=</span><span class="mi">0</span>
    <span class="p">))</span>

    <span class="c1"># Step 3: Clean full data</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;- Step 3: Cleaning synopsis data...&quot;</span><span class="p">)</span>
    <span class="n">clean_romance_synopsis</span><span class="p">(</span>
        <span class="n">input_csv</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">output_csv</span><span class="o">=</span><span class="kc">None</span>
    <span class="p">)</span>

    <span class="c1"># Step 4: Split combined XLSX into metadata + synopsis</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;- Step 4: Splitting movie data into metadata and synopsis files...&quot;</span><span class="p">)</span>
    <span class="n">metadata_path</span><span class="p">,</span> <span class="n">synopsis_path</span> <span class="o">=</span> <span class="n">split_movie_xlsx</span><span class="p">()</span>

    <span class="c1"># Step 5: Upload metadata to Google Drive</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;- Step 5: Uploading metadata Excel to Google Drive...&quot;</span><span class="p">)</span>
    <span class="n">upload_metadata_to_drive</span><span class="p">(</span><span class="n">file_path</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">file_name</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>

    <span class="c1"># Step 6: Upload metadata from Drive to BigQuery</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;- Step 6: Uploading metadata from Drive to BigQuery...&quot;</span><span class="p">)</span>
    <span class="n">upload_single_file_to_bigquery</span><span class="p">(</span>
        <span class="n">target_file_name</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">dataset_id</span><span class="o">=</span><span class="s2">&quot;romance_dataset&quot;</span><span class="p">,</span>
        <span class="n">table_name</span><span class="o">=</span><span class="s2">&quot;full_data_table&quot;</span>
    <span class="p">)</span>

    <span class="c1"># Step 7: Chunk and embed</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;- Step 7: Chunking and embedding synopsis...&quot;</span><span class="p">)</span>
    <span class="n">run_chunk_and_embed_pipeline</span><span class="p">(</span>
        <span class="n">input_excel</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">output_dir</span><span class="o">=</span><span class="kc">None</span>
    <span class="p">)</span>

    <span class="c1"># Step 7.5: Move ZIP to etl/data/jsons/</span>
    <span class="n">src_zip</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">JSONS_FOLDER</span><span class="si">}</span><span class="s2">.zip&quot;</span>
    <span class="n">dst_zip</span> <span class="o">=</span> <span class="s2">&quot;../etl/data/jsons/&quot;</span> <span class="o">+</span> <span class="n">src_zip</span>

    <span class="c1"># Ensure the destination directory exists and move the ZIP file</span>
    <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="s2">&quot;../etl/data/jsons&quot;</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">shutil</span><span class="o">.</span><span class="n">move</span><span class="p">(</span><span class="n">src_zip</span><span class="p">,</span> <span class="n">dst_zip</span><span class="p">)</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;- Moved ZIP to: </span><span class="si">{</span><span class="n">dst_zip</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="c1"># === CLEANUP ===</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="c1"># Delete romance_newbatch.tsv</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">TSV_FILENAME</span><span class="p">):</span>
            <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">TSV_FILENAME</span><span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;- Removed file: </span><span class="si">{</span><span class="n">TSV_FILENAME</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="c1"># Delete imdb_data/ folder</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="s2">&quot;imdb_data&quot;</span><span class="p">):</span>
            <span class="n">shutil</span><span class="o">.</span><span class="n">rmtree</span><span class="p">(</span><span class="s2">&quot;imdb_data&quot;</span><span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;- Removed folder: imdb_data/&quot;</span><span class="p">)</span>

        <span class="c1"># Delete romance_chunks_json/ folder</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">JSONS_FOLDER</span><span class="p">):</span>
            <span class="n">shutil</span><span class="o">.</span><span class="n">rmtree</span><span class="p">(</span><span class="n">JSONS_FOLDER</span><span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;- Removed folder: </span><span class="si">{</span><span class="n">JSONS_FOLDER</span><span class="si">}</span><span class="s2">/&quot;</span><span class="p">)</span>

    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;- Cleanup issue: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="c1"># Log pipeline completion</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;- Pipeline execution complete!&quot;</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
          </details>
  </div>

</div>



  </div>

  </div>

</div><h2 id="-submodules">- Submodules</h2>


<div class="doc doc-object doc-module">



<a id="app.pipeline.scrape_tt_codes"></a>
  <div class="doc doc-contents first">

  

  <div class="doc doc-children">










<div class="doc doc-object doc-function">




<h2 id="app.pipeline.scrape_tt_codes.extract_tt_codes" class="doc doc-heading">
          <code class="highlight language-python"><span class="n">extract_tt_codes</span><span class="p">(</span><span class="n">html</span><span class="p">)</span></code>
  
  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-async"><code>async</code></small>
  </span>

</h2>


  <div class="doc doc-contents ">
  
      <p>Extracts IMDb tt codes from the provided HTML content.</p>



  <p><strong>Parameters:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Name</th>
        <th>Type</th>
        <th>Description</th>
        <th>Default</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td><code>html</code></td>
          <td>
                <code>str</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>The HTML content of the IMDb page.</p>
            </div>
          </td>
          <td>
              <em>required</em>
          </td>
        </tr>
    </tbody>
  </table>



  <p><strong>Returns:</strong></p>
  <table>
    <thead>
      <tr>
<th>Name</th>        <th>Type</th>
        <th>Description</th>
      </tr>
    </thead>
    <tbody>
        <tr>
<td><code>set</code></td>          <td>
                <code><span title="typing.Set">Set</span>[str]</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>A set of unique tt codes extracted from the page.</p>
            </div>
          </td>
        </tr>
    </tbody>
  </table>

          <details class="quote">
            <summary>Source code in <code>app/pipeline/scrape_tt_codes.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">15</span>
<span class="normal">16</span>
<span class="normal">17</span>
<span class="normal">18</span>
<span class="normal">19</span>
<span class="normal">20</span>
<span class="normal">21</span>
<span class="normal">22</span>
<span class="normal">23</span>
<span class="normal">24</span>
<span class="normal">25</span>
<span class="normal">26</span>
<span class="normal">27</span>
<span class="normal">28</span>
<span class="normal">29</span>
<span class="normal">30</span>
<span class="normal">31</span>
<span class="normal">32</span>
<span class="normal">33</span>
<span class="normal">34</span>
<span class="normal">35</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">extract_tt_codes</span><span class="p">(</span><span class="n">html</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Set</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Extracts IMDb tt codes from the provided HTML content.</span>

<span class="sd">    Args:</span>
<span class="sd">        html (str): The HTML content of the IMDb page.</span>

<span class="sd">    Returns:</span>
<span class="sd">        set: A set of unique tt codes extracted from the page.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">soup</span> <span class="o">=</span> <span class="n">BeautifulSoup</span><span class="p">(</span><span class="n">html</span><span class="p">,</span> <span class="s2">&quot;html.parser&quot;</span><span class="p">)</span>
    <span class="n">movie_list</span> <span class="o">=</span> <span class="n">soup</span><span class="o">.</span><span class="n">find_all</span><span class="p">(</span><span class="s2">&quot;li&quot;</span><span class="p">,</span> <span class="p">{</span><span class="s2">&quot;class&quot;</span><span class="p">:</span> <span class="s2">&quot;ipc-metadata-list-summary-item&quot;</span><span class="p">})</span>

    <span class="n">tt_codes</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">movie</span> <span class="ow">in</span> <span class="n">movie_list</span><span class="p">:</span>
        <span class="n">link</span> <span class="o">=</span> <span class="n">movie</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s2">&quot;a&quot;</span><span class="p">,</span> <span class="p">{</span><span class="s2">&quot;class&quot;</span><span class="p">:</span> <span class="s2">&quot;ipc-title-link-wrapper&quot;</span><span class="p">,</span> <span class="s2">&quot;href&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">})</span>
        <span class="k">if</span> <span class="n">link</span><span class="p">:</span>
            <span class="n">match</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;/title/(tt\d+)/&quot;</span><span class="p">,</span> <span class="n">link</span><span class="p">[</span><span class="s2">&quot;href&quot;</span><span class="p">])</span>
            <span class="k">if</span> <span class="n">match</span><span class="p">:</span>
                <span class="n">tt_codes</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">match</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span>  <span class="c1"># Extract tt_code</span>
    <span class="k">return</span> <span class="n">tt_codes</span>
</code></pre></div></td></tr></table></div>
          </details>
  </div>

</div>


<div class="doc doc-object doc-function">




<h2 id="app.pipeline.scrape_tt_codes.run_scraper" class="doc doc-heading">
          <code class="highlight language-python"><span class="n">run_scraper</span><span class="p">()</span></code>

</h2>


  <div class="doc doc-contents ">
  
      <p>Runs the IMDb tt code scraper.</p>
<p>This function initializes the asynchronous scraping process and ensures
that the <code>scrape_imdb_movie_codes</code> coroutine is executed.</p>

          <details class="quote">
            <summary>Source code in <code>app/pipeline/scrape_tt_codes.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">114</span>
<span class="normal">115</span>
<span class="normal">116</span>
<span class="normal">117</span>
<span class="normal">118</span>
<span class="normal">119</span>
<span class="normal">120</span>
<span class="normal">121</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">run_scraper</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Runs the IMDb tt code scraper.</span>

<span class="sd">    This function initializes the asynchronous scraping process and ensures</span>
<span class="sd">    that the `scrape_imdb_movie_codes` coroutine is executed.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">asyncio</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">scrape_imdb_movie_codes</span><span class="p">())</span>
</code></pre></div></td></tr></table></div>
          </details>
  </div>

</div>


<div class="doc doc-object doc-function">




<h2 id="app.pipeline.scrape_tt_codes.scrape_imdb_movie_codes" class="doc doc-heading">
          <code class="highlight language-python"><span class="n">scrape_imdb_movie_codes</span><span class="p">()</span></code>
  
  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-async"><code>async</code></small>
  </span>

</h2>


  <div class="doc doc-contents ">
  
      <p>Scrapes IMDb movie tt codes by navigating through the IMDb page and extracting tt codes.
The extracted tt codes are saved to a TSV file.</p>

<details class="steps" open>
  <summary>Steps</summary>
  <ol>
<li>Opens the IMDb URL using Playwright.</li>
<li>Extracts tt codes from the current page.</li>
<li>Saves new tt codes to a TSV file.</li>
<li>Clicks the "Show More" button to load additional movies and repeats the process.</li>
</ol>
</details>


  <p><strong>Raises:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Type</th>
        <th>Description</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td>
                <code>Exception</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>If any error occurs during the scraping process.</p>
            </div>
          </td>
        </tr>
    </tbody>
  </table>

          <details class="quote">
            <summary>Source code in <code>app/pipeline/scrape_tt_codes.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 38</span>
<span class="normal"> 39</span>
<span class="normal"> 40</span>
<span class="normal"> 41</span>
<span class="normal"> 42</span>
<span class="normal"> 43</span>
<span class="normal"> 44</span>
<span class="normal"> 45</span>
<span class="normal"> 46</span>
<span class="normal"> 47</span>
<span class="normal"> 48</span>
<span class="normal"> 49</span>
<span class="normal"> 50</span>
<span class="normal"> 51</span>
<span class="normal"> 52</span>
<span class="normal"> 53</span>
<span class="normal"> 54</span>
<span class="normal"> 55</span>
<span class="normal"> 56</span>
<span class="normal"> 57</span>
<span class="normal"> 58</span>
<span class="normal"> 59</span>
<span class="normal"> 60</span>
<span class="normal"> 61</span>
<span class="normal"> 62</span>
<span class="normal"> 63</span>
<span class="normal"> 64</span>
<span class="normal"> 65</span>
<span class="normal"> 66</span>
<span class="normal"> 67</span>
<span class="normal"> 68</span>
<span class="normal"> 69</span>
<span class="normal"> 70</span>
<span class="normal"> 71</span>
<span class="normal"> 72</span>
<span class="normal"> 73</span>
<span class="normal"> 74</span>
<span class="normal"> 75</span>
<span class="normal"> 76</span>
<span class="normal"> 77</span>
<span class="normal"> 78</span>
<span class="normal"> 79</span>
<span class="normal"> 80</span>
<span class="normal"> 81</span>
<span class="normal"> 82</span>
<span class="normal"> 83</span>
<span class="normal"> 84</span>
<span class="normal"> 85</span>
<span class="normal"> 86</span>
<span class="normal"> 87</span>
<span class="normal"> 88</span>
<span class="normal"> 89</span>
<span class="normal"> 90</span>
<span class="normal"> 91</span>
<span class="normal"> 92</span>
<span class="normal"> 93</span>
<span class="normal"> 94</span>
<span class="normal"> 95</span>
<span class="normal"> 96</span>
<span class="normal"> 97</span>
<span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span>
<span class="normal">102</span>
<span class="normal">103</span>
<span class="normal">104</span>
<span class="normal">105</span>
<span class="normal">106</span>
<span class="normal">107</span>
<span class="normal">108</span>
<span class="normal">109</span>
<span class="normal">110</span>
<span class="normal">111</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">scrape_imdb_movie_codes</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Scrapes IMDb movie tt codes by navigating through the IMDb page and extracting tt codes.</span>
<span class="sd">    The extracted tt codes are saved to a TSV file.</span>

<span class="sd">    Steps:</span>
<span class="sd">        1. Opens the IMDb URL using Playwright.</span>
<span class="sd">        2. Extracts tt codes from the current page.</span>
<span class="sd">        3. Saves new tt codes to a TSV file.</span>
<span class="sd">        4. Clicks the &quot;Show More&quot; button to load additional movies and repeats the process.</span>

<span class="sd">    Raises:</span>
<span class="sd">        Exception: If any error occurs during the scraping process.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">async</span> <span class="k">with</span> <span class="n">async_playwright</span><span class="p">()</span> <span class="k">as</span> <span class="n">p</span><span class="p">:</span>
        <span class="n">browser</span> <span class="o">=</span> <span class="k">await</span> <span class="n">p</span><span class="o">.</span><span class="n">chromium</span><span class="o">.</span><span class="n">launch</span><span class="p">(</span><span class="n">headless</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>  <span class="c1"># Set to True for headless mode</span>
        <span class="n">page</span> <span class="o">=</span> <span class="k">await</span> <span class="n">browser</span><span class="o">.</span><span class="n">new_page</span><span class="p">()</span>

        <span class="c1"># Load IMDb page</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Opening </span><span class="si">{</span><span class="n">URL</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">await</span> <span class="n">page</span><span class="o">.</span><span class="n">goto</span><span class="p">(</span><span class="n">URL</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">120000</span><span class="p">)</span>
        <span class="k">await</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>  <span class="c1"># Wait for initial page load</span>

        <span class="n">saved_codes</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>

        <span class="c1"># Load existing codes from CSV</span>
        <span class="k">if</span> <span class="n">Path</span><span class="p">(</span><span class="n">TSV_FILENAME</span><span class="p">)</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">TSV_FILENAME</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="p">,</span> <span class="n">newline</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">file</span><span class="p">:</span>
                <span class="n">reader</span> <span class="o">=</span> <span class="n">csv</span><span class="o">.</span><span class="n">reader</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="n">delimiter</span><span class="o">=</span><span class="s2">&quot;</span><span class="se">\t</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="nb">next</span><span class="p">(</span><span class="n">reader</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
                <span class="n">saved_codes</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">reader</span><span class="p">)</span>

        <span class="c1"># Open CSV for writing</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">TSV_FILENAME</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">,</span> <span class="n">newline</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">file</span><span class="p">:</span>
            <span class="n">writer</span> <span class="o">=</span> <span class="n">csv</span><span class="o">.</span><span class="n">writer</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="n">delimiter</span><span class="o">=</span><span class="s2">&quot;</span><span class="se">\t</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">writer</span><span class="o">.</span><span class="n">writerow</span><span class="p">([</span><span class="s2">&quot;tconst&quot;</span><span class="p">])</span>

            <span class="n">click_attempts</span> <span class="o">=</span> <span class="mi">0</span>

            <span class="k">while</span> <span class="n">click_attempts</span> <span class="o">&lt;</span> <span class="n">MAX_CLICKS</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Scraping Page </span><span class="si">{</span><span class="n">click_attempts</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="si">}</span><span class="s2">...&quot;</span><span class="p">)</span>

                <span class="c1"># Extract tt_codes from the current page</span>
                <span class="n">html</span> <span class="o">=</span> <span class="k">await</span> <span class="n">page</span><span class="o">.</span><span class="n">content</span><span class="p">()</span>
                <span class="n">new_tt_codes</span> <span class="o">=</span> <span class="k">await</span> <span class="n">extract_tt_codes</span><span class="p">(</span><span class="n">html</span><span class="p">)</span>

                <span class="c1"># Save only new tt_codes</span>
                <span class="n">unique_tt_codes</span> <span class="o">=</span> <span class="n">new_tt_codes</span> <span class="o">-</span> <span class="n">saved_codes</span>
                <span class="k">if</span> <span class="n">unique_tt_codes</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">code</span> <span class="ow">in</span> <span class="n">unique_tt_codes</span><span class="p">:</span>
                        <span class="n">writer</span><span class="o">.</span><span class="n">writerow</span><span class="p">([</span><span class="n">code</span><span class="p">])</span>
                        <span class="n">saved_codes</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">code</span><span class="p">)</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Saved </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">unique_tt_codes</span><span class="p">)</span><span class="si">}</span><span class="s2"> new tt_codes to CSV.&quot;</span><span class="p">)</span>

                <span class="c1"># Try clicking &quot;Show More&quot; button</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">show_more_button</span> <span class="o">=</span> <span class="k">await</span> <span class="n">page</span><span class="o">.</span><span class="n">wait_for_selector</span><span class="p">(</span><span class="s2">&quot;button.ipc-see-more__button&quot;</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">5000</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">show_more_button</span><span class="p">:</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Clicking &#39;Show More&#39; button...&quot;</span><span class="p">)</span>
                        <span class="k">await</span> <span class="n">show_more_button</span><span class="o">.</span><span class="n">scroll_into_view_if_needed</span><span class="p">()</span>
                        <span class="k">await</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>  <span class="c1"># Small delay before clicking</span>
                        <span class="k">await</span> <span class="n">show_more_button</span><span class="o">.</span><span class="n">click</span><span class="p">()</span>
                        <span class="k">await</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>  <span class="c1"># Wait for more movies to load</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;No more &#39;Show More&#39; button found. Stopping scrape.&quot;</span><span class="p">)</span>
                        <span class="k">break</span>
                <span class="k">except</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;No more &#39;Show More&#39; button detected.&quot;</span><span class="p">)</span>
                    <span class="k">break</span>

                <span class="n">click_attempts</span> <span class="o">+=</span> <span class="mi">1</span>

        <span class="k">await</span> <span class="n">browser</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Scraping completed successfully!&quot;</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
          </details>
  </div>

</div>



  </div>

  </div>

</div>

<div class="doc doc-object doc-module">



<a id="app.pipeline.extract_movie_data"></a>
  <div class="doc doc-contents first">

  

  <div class="doc doc-children">








<div class="doc doc-object doc-class">




<h2 id="app.pipeline.extract_movie_data.IMDbCrawler" class="doc doc-heading">
          <code>IMDbCrawler</code>


</h2>


  <div class="doc doc-contents ">

  
      <p>An asynchronous web crawler for scraping IMDb movie metadata and synopses.</p>



  <p><strong>Attributes:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Name</th>
        <th>Type</th>
        <th>Description</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td><code>output_dir</code></td>
          <td>
                <code><span title="pathlib.Path">Path</span></code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>Directory to store output files.</p>
            </div>
          </td>
        </tr>
        <tr>
          <td><code>min_delay</code></td>
          <td>
                <code>float</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>Minimum delay between requests (for rate limiting).</p>
            </div>
          </td>
        </tr>
        <tr>
          <td><code>max_delay</code></td>
          <td>
                <code>float</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>Maximum delay between requests.</p>
            </div>
          </td>
        </tr>
        <tr>
          <td><code>max_retries</code></td>
          <td>
                <code>int</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>Number of retry attempts for failed requests.</p>
            </div>
          </td>
        </tr>
        <tr>
          <td><code>concurrent_requests</code></td>
          <td>
                <code>int</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>Maximum number of concurrent requests.</p>
            </div>
          </td>
        </tr>
        <tr>
          <td><code>headers</code></td>
          <td>
                <code>dict</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>HTTP headers to mimic browser behavior.</p>
            </div>
          </td>
        </tr>
        <tr>
          <td><code>session</code></td>
          <td>
                <code><span title="aiohttp.ClientSession">ClientSession</span></code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>Reusable HTTP session for requests.</p>
            </div>
          </td>
        </tr>
    </tbody>
  </table>

            <details class="quote">
              <summary>Source code in <code>app/pipeline/extract_movie_data.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 20</span>
<span class="normal"> 21</span>
<span class="normal"> 22</span>
<span class="normal"> 23</span>
<span class="normal"> 24</span>
<span class="normal"> 25</span>
<span class="normal"> 26</span>
<span class="normal"> 27</span>
<span class="normal"> 28</span>
<span class="normal"> 29</span>
<span class="normal"> 30</span>
<span class="normal"> 31</span>
<span class="normal"> 32</span>
<span class="normal"> 33</span>
<span class="normal"> 34</span>
<span class="normal"> 35</span>
<span class="normal"> 36</span>
<span class="normal"> 37</span>
<span class="normal"> 38</span>
<span class="normal"> 39</span>
<span class="normal"> 40</span>
<span class="normal"> 41</span>
<span class="normal"> 42</span>
<span class="normal"> 43</span>
<span class="normal"> 44</span>
<span class="normal"> 45</span>
<span class="normal"> 46</span>
<span class="normal"> 47</span>
<span class="normal"> 48</span>
<span class="normal"> 49</span>
<span class="normal"> 50</span>
<span class="normal"> 51</span>
<span class="normal"> 52</span>
<span class="normal"> 53</span>
<span class="normal"> 54</span>
<span class="normal"> 55</span>
<span class="normal"> 56</span>
<span class="normal"> 57</span>
<span class="normal"> 58</span>
<span class="normal"> 59</span>
<span class="normal"> 60</span>
<span class="normal"> 61</span>
<span class="normal"> 62</span>
<span class="normal"> 63</span>
<span class="normal"> 64</span>
<span class="normal"> 65</span>
<span class="normal"> 66</span>
<span class="normal"> 67</span>
<span class="normal"> 68</span>
<span class="normal"> 69</span>
<span class="normal"> 70</span>
<span class="normal"> 71</span>
<span class="normal"> 72</span>
<span class="normal"> 73</span>
<span class="normal"> 74</span>
<span class="normal"> 75</span>
<span class="normal"> 76</span>
<span class="normal"> 77</span>
<span class="normal"> 78</span>
<span class="normal"> 79</span>
<span class="normal"> 80</span>
<span class="normal"> 81</span>
<span class="normal"> 82</span>
<span class="normal"> 83</span>
<span class="normal"> 84</span>
<span class="normal"> 85</span>
<span class="normal"> 86</span>
<span class="normal"> 87</span>
<span class="normal"> 88</span>
<span class="normal"> 89</span>
<span class="normal"> 90</span>
<span class="normal"> 91</span>
<span class="normal"> 92</span>
<span class="normal"> 93</span>
<span class="normal"> 94</span>
<span class="normal"> 95</span>
<span class="normal"> 96</span>
<span class="normal"> 97</span>
<span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span>
<span class="normal">102</span>
<span class="normal">103</span>
<span class="normal">104</span>
<span class="normal">105</span>
<span class="normal">106</span>
<span class="normal">107</span>
<span class="normal">108</span>
<span class="normal">109</span>
<span class="normal">110</span>
<span class="normal">111</span>
<span class="normal">112</span>
<span class="normal">113</span>
<span class="normal">114</span>
<span class="normal">115</span>
<span class="normal">116</span>
<span class="normal">117</span>
<span class="normal">118</span>
<span class="normal">119</span>
<span class="normal">120</span>
<span class="normal">121</span>
<span class="normal">122</span>
<span class="normal">123</span>
<span class="normal">124</span>
<span class="normal">125</span>
<span class="normal">126</span>
<span class="normal">127</span>
<span class="normal">128</span>
<span class="normal">129</span>
<span class="normal">130</span>
<span class="normal">131</span>
<span class="normal">132</span>
<span class="normal">133</span>
<span class="normal">134</span>
<span class="normal">135</span>
<span class="normal">136</span>
<span class="normal">137</span>
<span class="normal">138</span>
<span class="normal">139</span>
<span class="normal">140</span>
<span class="normal">141</span>
<span class="normal">142</span>
<span class="normal">143</span>
<span class="normal">144</span>
<span class="normal">145</span>
<span class="normal">146</span>
<span class="normal">147</span>
<span class="normal">148</span>
<span class="normal">149</span>
<span class="normal">150</span>
<span class="normal">151</span>
<span class="normal">152</span>
<span class="normal">153</span>
<span class="normal">154</span>
<span class="normal">155</span>
<span class="normal">156</span>
<span class="normal">157</span>
<span class="normal">158</span>
<span class="normal">159</span>
<span class="normal">160</span>
<span class="normal">161</span>
<span class="normal">162</span>
<span class="normal">163</span>
<span class="normal">164</span>
<span class="normal">165</span>
<span class="normal">166</span>
<span class="normal">167</span>
<span class="normal">168</span>
<span class="normal">169</span>
<span class="normal">170</span>
<span class="normal">171</span>
<span class="normal">172</span>
<span class="normal">173</span>
<span class="normal">174</span>
<span class="normal">175</span>
<span class="normal">176</span>
<span class="normal">177</span>
<span class="normal">178</span>
<span class="normal">179</span>
<span class="normal">180</span>
<span class="normal">181</span>
<span class="normal">182</span>
<span class="normal">183</span>
<span class="normal">184</span>
<span class="normal">185</span>
<span class="normal">186</span>
<span class="normal">187</span>
<span class="normal">188</span>
<span class="normal">189</span>
<span class="normal">190</span>
<span class="normal">191</span>
<span class="normal">192</span>
<span class="normal">193</span>
<span class="normal">194</span>
<span class="normal">195</span>
<span class="normal">196</span>
<span class="normal">197</span>
<span class="normal">198</span>
<span class="normal">199</span>
<span class="normal">200</span>
<span class="normal">201</span>
<span class="normal">202</span>
<span class="normal">203</span>
<span class="normal">204</span>
<span class="normal">205</span>
<span class="normal">206</span>
<span class="normal">207</span>
<span class="normal">208</span>
<span class="normal">209</span>
<span class="normal">210</span>
<span class="normal">211</span>
<span class="normal">212</span>
<span class="normal">213</span>
<span class="normal">214</span>
<span class="normal">215</span>
<span class="normal">216</span>
<span class="normal">217</span>
<span class="normal">218</span>
<span class="normal">219</span>
<span class="normal">220</span>
<span class="normal">221</span>
<span class="normal">222</span>
<span class="normal">223</span>
<span class="normal">224</span>
<span class="normal">225</span>
<span class="normal">226</span>
<span class="normal">227</span>
<span class="normal">228</span>
<span class="normal">229</span>
<span class="normal">230</span>
<span class="normal">231</span>
<span class="normal">232</span>
<span class="normal">233</span>
<span class="normal">234</span>
<span class="normal">235</span>
<span class="normal">236</span>
<span class="normal">237</span>
<span class="normal">238</span>
<span class="normal">239</span>
<span class="normal">240</span>
<span class="normal">241</span>
<span class="normal">242</span>
<span class="normal">243</span>
<span class="normal">244</span>
<span class="normal">245</span>
<span class="normal">246</span>
<span class="normal">247</span>
<span class="normal">248</span>
<span class="normal">249</span>
<span class="normal">250</span>
<span class="normal">251</span>
<span class="normal">252</span>
<span class="normal">253</span>
<span class="normal">254</span>
<span class="normal">255</span>
<span class="normal">256</span>
<span class="normal">257</span>
<span class="normal">258</span>
<span class="normal">259</span>
<span class="normal">260</span>
<span class="normal">261</span>
<span class="normal">262</span>
<span class="normal">263</span>
<span class="normal">264</span>
<span class="normal">265</span>
<span class="normal">266</span>
<span class="normal">267</span>
<span class="normal">268</span>
<span class="normal">269</span>
<span class="normal">270</span>
<span class="normal">271</span>
<span class="normal">272</span>
<span class="normal">273</span>
<span class="normal">274</span>
<span class="normal">275</span>
<span class="normal">276</span>
<span class="normal">277</span>
<span class="normal">278</span>
<span class="normal">279</span>
<span class="normal">280</span>
<span class="normal">281</span>
<span class="normal">282</span>
<span class="normal">283</span>
<span class="normal">284</span>
<span class="normal">285</span>
<span class="normal">286</span>
<span class="normal">287</span>
<span class="normal">288</span>
<span class="normal">289</span>
<span class="normal">290</span>
<span class="normal">291</span>
<span class="normal">292</span>
<span class="normal">293</span>
<span class="normal">294</span>
<span class="normal">295</span>
<span class="normal">296</span>
<span class="normal">297</span>
<span class="normal">298</span>
<span class="normal">299</span>
<span class="normal">300</span>
<span class="normal">301</span>
<span class="normal">302</span>
<span class="normal">303</span>
<span class="normal">304</span>
<span class="normal">305</span>
<span class="normal">306</span>
<span class="normal">307</span>
<span class="normal">308</span>
<span class="normal">309</span>
<span class="normal">310</span>
<span class="normal">311</span>
<span class="normal">312</span>
<span class="normal">313</span>
<span class="normal">314</span>
<span class="normal">315</span>
<span class="normal">316</span>
<span class="normal">317</span>
<span class="normal">318</span>
<span class="normal">319</span>
<span class="normal">320</span>
<span class="normal">321</span>
<span class="normal">322</span>
<span class="normal">323</span>
<span class="normal">324</span>
<span class="normal">325</span>
<span class="normal">326</span>
<span class="normal">327</span>
<span class="normal">328</span>
<span class="normal">329</span>
<span class="normal">330</span>
<span class="normal">331</span>
<span class="normal">332</span>
<span class="normal">333</span>
<span class="normal">334</span>
<span class="normal">335</span>
<span class="normal">336</span>
<span class="normal">337</span>
<span class="normal">338</span>
<span class="normal">339</span>
<span class="normal">340</span>
<span class="normal">341</span>
<span class="normal">342</span>
<span class="normal">343</span>
<span class="normal">344</span>
<span class="normal">345</span>
<span class="normal">346</span>
<span class="normal">347</span>
<span class="normal">348</span>
<span class="normal">349</span>
<span class="normal">350</span>
<span class="normal">351</span>
<span class="normal">352</span>
<span class="normal">353</span>
<span class="normal">354</span>
<span class="normal">355</span>
<span class="normal">356</span>
<span class="normal">357</span>
<span class="normal">358</span>
<span class="normal">359</span>
<span class="normal">360</span>
<span class="normal">361</span>
<span class="normal">362</span>
<span class="normal">363</span>
<span class="normal">364</span>
<span class="normal">365</span>
<span class="normal">366</span>
<span class="normal">367</span>
<span class="normal">368</span>
<span class="normal">369</span>
<span class="normal">370</span>
<span class="normal">371</span>
<span class="normal">372</span>
<span class="normal">373</span>
<span class="normal">374</span>
<span class="normal">375</span>
<span class="normal">376</span>
<span class="normal">377</span>
<span class="normal">378</span>
<span class="normal">379</span>
<span class="normal">380</span>
<span class="normal">381</span>
<span class="normal">382</span>
<span class="normal">383</span>
<span class="normal">384</span>
<span class="normal">385</span>
<span class="normal">386</span>
<span class="normal">387</span>
<span class="normal">388</span>
<span class="normal">389</span>
<span class="normal">390</span>
<span class="normal">391</span>
<span class="normal">392</span>
<span class="normal">393</span>
<span class="normal">394</span>
<span class="normal">395</span>
<span class="normal">396</span>
<span class="normal">397</span>
<span class="normal">398</span>
<span class="normal">399</span>
<span class="normal">400</span>
<span class="normal">401</span>
<span class="normal">402</span>
<span class="normal">403</span>
<span class="normal">404</span>
<span class="normal">405</span>
<span class="normal">406</span>
<span class="normal">407</span>
<span class="normal">408</span>
<span class="normal">409</span>
<span class="normal">410</span>
<span class="normal">411</span>
<span class="normal">412</span>
<span class="normal">413</span>
<span class="normal">414</span>
<span class="normal">415</span>
<span class="normal">416</span>
<span class="normal">417</span>
<span class="normal">418</span>
<span class="normal">419</span>
<span class="normal">420</span>
<span class="normal">421</span>
<span class="normal">422</span>
<span class="normal">423</span>
<span class="normal">424</span>
<span class="normal">425</span>
<span class="normal">426</span>
<span class="normal">427</span>
<span class="normal">428</span>
<span class="normal">429</span>
<span class="normal">430</span>
<span class="normal">431</span>
<span class="normal">432</span>
<span class="normal">433</span>
<span class="normal">434</span>
<span class="normal">435</span>
<span class="normal">436</span>
<span class="normal">437</span>
<span class="normal">438</span>
<span class="normal">439</span>
<span class="normal">440</span>
<span class="normal">441</span>
<span class="normal">442</span>
<span class="normal">443</span>
<span class="normal">444</span>
<span class="normal">445</span>
<span class="normal">446</span>
<span class="normal">447</span>
<span class="normal">448</span>
<span class="normal">449</span>
<span class="normal">450</span>
<span class="normal">451</span>
<span class="normal">452</span>
<span class="normal">453</span>
<span class="normal">454</span>
<span class="normal">455</span>
<span class="normal">456</span>
<span class="normal">457</span>
<span class="normal">458</span>
<span class="normal">459</span>
<span class="normal">460</span>
<span class="normal">461</span>
<span class="normal">462</span>
<span class="normal">463</span>
<span class="normal">464</span>
<span class="normal">465</span>
<span class="normal">466</span>
<span class="normal">467</span>
<span class="normal">468</span>
<span class="normal">469</span>
<span class="normal">470</span>
<span class="normal">471</span>
<span class="normal">472</span>
<span class="normal">473</span>
<span class="normal">474</span>
<span class="normal">475</span>
<span class="normal">476</span>
<span class="normal">477</span>
<span class="normal">478</span>
<span class="normal">479</span>
<span class="normal">480</span>
<span class="normal">481</span>
<span class="normal">482</span>
<span class="normal">483</span>
<span class="normal">484</span>
<span class="normal">485</span>
<span class="normal">486</span>
<span class="normal">487</span>
<span class="normal">488</span>
<span class="normal">489</span>
<span class="normal">490</span>
<span class="normal">491</span>
<span class="normal">492</span>
<span class="normal">493</span>
<span class="normal">494</span>
<span class="normal">495</span>
<span class="normal">496</span>
<span class="normal">497</span>
<span class="normal">498</span>
<span class="normal">499</span>
<span class="normal">500</span>
<span class="normal">501</span>
<span class="normal">502</span>
<span class="normal">503</span>
<span class="normal">504</span>
<span class="normal">505</span>
<span class="normal">506</span>
<span class="normal">507</span>
<span class="normal">508</span>
<span class="normal">509</span>
<span class="normal">510</span>
<span class="normal">511</span>
<span class="normal">512</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">IMDbCrawler</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    An asynchronous web crawler for scraping IMDb movie metadata and synopses.</span>

<span class="sd">    Attributes:</span>
<span class="sd">        output_dir (Path): Directory to store output files.</span>
<span class="sd">        min_delay (float): Minimum delay between requests (for rate limiting).</span>
<span class="sd">        max_delay (float): Maximum delay between requests.</span>
<span class="sd">        max_retries (int): Number of retry attempts for failed requests.</span>
<span class="sd">        concurrent_requests (int): Maximum number of concurrent requests.</span>
<span class="sd">        headers (dict): HTTP headers to mimic browser behavior.</span>
<span class="sd">        session (aiohttp.ClientSession): Reusable HTTP session for requests.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">output_dir</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;imdb_data&quot;</span><span class="p">,</span>
                 <span class="n">min_delay</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">2.0</span><span class="p">,</span>
                 <span class="n">max_delay</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">4.0</span><span class="p">,</span>
                 <span class="n">max_retries</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">3</span><span class="p">,</span>
                 <span class="n">concurrent_requests</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">3</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>

        <span class="c1"># Initialize directory structure</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">output_dir</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">output_dir</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">output_dir</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="c1"># Set crawler parameters</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">min_delay</span> <span class="o">=</span> <span class="n">min_delay</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">max_delay</span> <span class="o">=</span> <span class="n">max_delay</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">max_retries</span> <span class="o">=</span> <span class="n">max_retries</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">concurrent_requests</span> <span class="o">=</span> <span class="n">concurrent_requests</span>

        <span class="c1"># Configure request headers to mimic browser</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">headers</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;User-Agent&#39;</span><span class="p">:</span> <span class="s1">&#39;Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/537.36...&#39;</span><span class="p">,</span>
            <span class="s1">&#39;Accept&#39;</span><span class="p">:</span> <span class="s1">&#39;text/html,application/xhtml+xml,application/xml;q=0.9,...&#39;</span><span class="p">,</span>
            <span class="s1">&#39;Accept-Language&#39;</span><span class="p">:</span> <span class="s1">&#39;en-US,en;q=0.9&#39;</span><span class="p">,</span>
            <span class="s1">&#39;Accept-Encoding&#39;</span><span class="p">:</span> <span class="s1">&#39;gzip, deflate, br&#39;</span><span class="p">,</span>
            <span class="s1">&#39;Connection&#39;</span><span class="p">:</span> <span class="s1">&#39;keep-alive&#39;</span><span class="p">,</span>
            <span class="s1">&#39;Upgrade-Insecure-Requests&#39;</span><span class="p">:</span> <span class="s1">&#39;1&#39;</span>
        <span class="p">}</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">session</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">init_session</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Initializes the aiohttp session with SSL context.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">session</span><span class="p">:</span>
            <span class="c1"># Create SSL context with proper certificate verification</span>
            <span class="n">ssl_context</span> <span class="o">=</span> <span class="n">ssl</span><span class="o">.</span><span class="n">create_default_context</span><span class="p">(</span><span class="n">cafile</span><span class="o">=</span><span class="n">certifi</span><span class="o">.</span><span class="n">where</span><span class="p">())</span>
            <span class="c1"># Configure TCP connector with SSL settings</span>
            <span class="n">connector</span> <span class="o">=</span> <span class="n">aiohttp</span><span class="o">.</span><span class="n">TCPConnector</span><span class="p">(</span>
                <span class="n">ssl</span><span class="o">=</span><span class="n">ssl_context</span><span class="p">,</span>
                <span class="n">verify_ssl</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                <span class="n">force_close</span><span class="o">=</span><span class="kc">True</span>  <span class="c1"># Ensure connections are closed after use</span>
            <span class="p">)</span>
            <span class="c1"># Create the client session</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">session</span> <span class="o">=</span> <span class="n">aiohttp</span><span class="o">.</span><span class="n">ClientSession</span><span class="p">(</span>
                <span class="n">headers</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">headers</span><span class="p">,</span>
                <span class="n">connector</span><span class="o">=</span><span class="n">connector</span>
            <span class="p">)</span>

    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">get_movies_from_tsv</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tsv_file</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">TSV_FILENAME</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Reads movie IDs from a TSV file and filters out already processed IDs.</span>

<span class="sd">        Args:</span>
<span class="sd">            tsv_file (str): Path to the input TSV file.</span>

<span class="sd">        Returns:</span>
<span class="sd">            List[str]: List of IMDb movie IDs to process.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># Read the input TSV file</span>
            <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">tsv_file</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="c1"># Check for and handle already processed movies</span>
            <span class="n">processed_file</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">output_dir</span> <span class="o">/</span> <span class="n">PROCESSED_IDS</span>
            <span class="k">if</span> <span class="n">processed_file</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
                <span class="n">processed_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">processed_file</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">&#39;</span><span class="p">)</span>
                <span class="n">processed_ids</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">processed_df</span><span class="p">[</span><span class="s1">&#39;tconst&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">tolist</span><span class="p">())</span>
                <span class="c1"># Remove already processed movies from the queue</span>
                <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="o">~</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;tconst&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">processed_ids</span><span class="p">)]</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Found </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="p">)</span><span class="si">}</span><span class="s2"> movies to process&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;tconst&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error reading TSV file: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="p">[]</span>

    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">record_processed_id</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tconst</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Records a processed IMDb ID into a TSV log with timestamp.</span>

<span class="sd">        Args:</span>
<span class="sd">            tconst (str): IMDb title ID.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">processed_file</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">output_dir</span> <span class="o">/</span> <span class="n">PROCESSED_IDS</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># Create DataFrame with movie ID and timestamp</span>
            <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span>
                <span class="s1">&#39;tconst&#39;</span><span class="p">:</span> <span class="p">[</span><span class="n">tconst</span><span class="p">],</span>
                <span class="s1">&#39;processed_time&#39;</span><span class="p">:</span> <span class="p">[</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">isoformat</span><span class="p">()]</span>
            <span class="p">})</span>
            <span class="c1"># Append or create the processed IDs file</span>
            <span class="k">if</span> <span class="n">processed_file</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
                <span class="n">df</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">processed_file</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;a&#39;</span><span class="p">,</span> <span class="n">header</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">df</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">processed_file</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error recording processed ID: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">extract_movie_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tconst</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span> <span class="kc">None</span><span class="p">]]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Extracts full metadata and synopsis info from IMDb for a single title.</span>

<span class="sd">        Args:</span>
<span class="sd">            tconst (str): IMDb title ID.</span>

<span class="sd">        Returns:</span>
<span class="sd">            Dict: Extracted movie data.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Initialize movie data structure with metadata</span>
        <span class="n">movie_data</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;tconst&#39;</span><span class="p">:</span> <span class="n">tconst</span><span class="p">,</span>
            <span class="s1">&#39;crawl_timestamp&#39;</span><span class="p">:</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">isoformat</span><span class="p">()</span>
        <span class="p">}</span>
        <span class="c1"># Construct main movie page URL</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">tconst</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;/title/&#39;</span><span class="p">):</span>
            <span class="n">main_url</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;https://www.imdb.com/title/</span><span class="si">{</span><span class="n">tconst</span><span class="si">}</span><span class="s2">/&quot;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">main_url</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;https://www.imdb.com</span><span class="si">{</span><span class="n">tconst</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Fetching movie data from: </span><span class="si">{</span><span class="n">main_url</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># Fetch and process main page</span>
            <span class="k">async</span> <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">main_url</span><span class="p">)</span> <span class="k">as</span> <span class="n">response</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">response</span><span class="o">.</span><span class="n">status</span> <span class="o">==</span> <span class="mi">200</span><span class="p">:</span>
                    <span class="n">html</span> <span class="o">=</span> <span class="k">await</span> <span class="n">response</span><span class="o">.</span><span class="n">text</span><span class="p">()</span>
                    <span class="n">soup</span> <span class="o">=</span> <span class="n">BeautifulSoup</span><span class="p">(</span><span class="n">html</span><span class="p">,</span> <span class="s1">&#39;html.parser&#39;</span><span class="p">)</span>
                    <span class="c1"># Extract all available data points</span>
                    <span class="n">movie_data</span><span class="o">.</span><span class="n">update</span><span class="p">({</span>
                        <span class="s1">&#39;movie_title&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_extract_title</span><span class="p">(</span><span class="n">soup</span><span class="p">),</span>
                        <span class="s1">&#39;movie_year&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_extract_year</span><span class="p">(</span><span class="n">soup</span><span class="p">,</span> <span class="n">tconst</span><span class="p">),</span>
                        <span class="s1">&#39;age_rating&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_extract_age_rating</span><span class="p">(</span><span class="n">soup</span><span class="p">,</span> <span class="n">tconst</span><span class="p">),</span>
                        <span class="s1">&#39;duration&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_extract_runtime</span><span class="p">(</span><span class="n">soup</span><span class="p">),</span>
                        <span class="s1">&#39;imdb_rating&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_extract_imdb_rating</span><span class="p">(</span><span class="n">soup</span><span class="p">),</span>
                        <span class="s1">&#39;short_synopsis&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_extract_short_synopsis</span><span class="p">(</span><span class="n">soup</span><span class="p">),</span>
                        <span class="s1">&#39;top_5_actors&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_extract_top_actors</span><span class="p">(</span><span class="n">soup</span><span class="p">),</span>
                        <span class="s1">&#39;genres&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_extract_genres</span><span class="p">(</span><span class="n">soup</span><span class="p">),</span>
                        <span class="s1">&#39;poster_url&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_extract_poster_url</span><span class="p">(</span><span class="n">soup</span><span class="p">),</span>
                        <span class="s1">&#39;summaries&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_extract_summaries</span><span class="p">(</span><span class="n">soup</span><span class="p">),</span>
                        <span class="s1">&#39;long_synopsis&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_extract_long_synopsis</span><span class="p">(</span><span class="n">soup</span><span class="p">),</span>
                    <span class="p">})</span>
                    <span class="c1"># Implement rate limiting</span>
                    <span class="k">await</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="n">random</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">min_delay</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_delay</span><span class="p">))</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Failed to get movie </span><span class="si">{</span><span class="n">tconst</span><span class="si">}</span><span class="s2">: Status </span><span class="si">{</span><span class="n">response</span><span class="o">.</span><span class="n">status</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error extracting main data for </span><span class="si">{</span><span class="n">tconst</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="c1"># Fetch and process plot summary page</span>
        <span class="n">plot_url</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;https://www.imdb.com/title/</span><span class="si">{</span><span class="n">tconst</span><span class="si">}</span><span class="s2">/plotsummary/&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">async</span> <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">plot_url</span><span class="p">)</span> <span class="k">as</span> <span class="n">response</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">response</span><span class="o">.</span><span class="n">status</span> <span class="o">==</span> <span class="mi">200</span><span class="p">:</span>
                    <span class="n">html</span> <span class="o">=</span> <span class="k">await</span> <span class="n">response</span><span class="o">.</span><span class="n">text</span><span class="p">()</span>
                    <span class="n">soup</span> <span class="o">=</span> <span class="n">BeautifulSoup</span><span class="p">(</span><span class="n">html</span><span class="p">,</span> <span class="s1">&#39;html.parser&#39;</span><span class="p">)</span>
                    <span class="n">movie_data</span><span class="p">[</span><span class="s1">&#39;long_synopsis&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_extract_long_synopsis</span><span class="p">(</span><span class="n">soup</span><span class="p">)</span>
                    <span class="n">movie_data</span><span class="p">[</span><span class="s1">&#39;summaries&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_extract_summaries</span><span class="p">(</span><span class="n">soup</span><span class="p">)</span>
                    <span class="k">await</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="n">random</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">min_delay</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_delay</span><span class="p">))</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error extracting plot data for </span><span class="si">{</span><span class="n">tconst</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">movie_data</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_extract_title</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">soup</span><span class="p">:</span> <span class="n">BeautifulSoup</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Extracts the movie title from the given HTML soup.</span>

<span class="sd">        Args:</span>
<span class="sd">            soup (BeautifulSoup): Parsed IMDb movie page.</span>

<span class="sd">        Returns:</span>
<span class="sd">            Optional[str]: Extracted movie title or default fallback.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># IMDb page structures can change, so we use multiple selector strategies</span>
            <span class="n">title_tag</span> <span class="o">=</span> <span class="n">soup</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s2">&quot;span&quot;</span><span class="p">,</span> <span class="p">{</span><span class="s2">&quot;data-testid&quot;</span><span class="p">:</span> <span class="s2">&quot;hero__primary-text&quot;</span><span class="p">})</span>
            <span class="c1"># Extract and return the title if found</span>
            <span class="k">return</span> <span class="n">title_tag</span><span class="o">.</span><span class="n">get_text</span><span class="p">(</span><span class="n">strip</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span> <span class="k">if</span> <span class="n">title_tag</span> <span class="k">else</span> <span class="s2">&quot;Title not found&quot;</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error extracting title: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">None</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_extract_long_synopsis</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">soup</span><span class="p">:</span> <span class="n">BeautifulSoup</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Extracts the long synopsis from the movie&#39;s IMDb plot page.</span>

<span class="sd">        Args:</span>
<span class="sd">            soup (BeautifulSoup): Parsed IMDb plot page HTML.</span>

<span class="sd">        Returns:</span>
<span class="sd">            Optional[str]: Full synopsis text or fallback message.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># Locate the full synopsis section</span>
            <span class="n">synopsis_section</span> <span class="o">=</span> <span class="n">soup</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s2">&quot;div&quot;</span><span class="p">,</span> <span class="p">{</span><span class="s2">&quot;data-testid&quot;</span><span class="p">:</span> <span class="s2">&quot;sub-section-synopsis&quot;</span><span class="p">})</span>
            <span class="c1"># Extract the full synopsis text if available</span>
            <span class="n">movie_synopsis</span> <span class="o">=</span> <span class="p">(</span>
                <span class="n">synopsis_section</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s2">&quot;div&quot;</span><span class="p">,</span> <span class="p">{</span><span class="s2">&quot;class&quot;</span><span class="p">:</span> <span class="s2">&quot;ipc-html-content-inner-div&quot;</span><span class="p">,</span> <span class="s2">&quot;role&quot;</span><span class="p">:</span> <span class="s2">&quot;presentation&quot;</span><span class="p">})</span><span class="o">.</span><span class="n">get_text</span><span class="p">(</span>
                    <span class="n">strip</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">synopsis_section</span> <span class="k">else</span> <span class="s2">&quot;Synopsis not found&quot;</span>
            <span class="p">)</span>
            <span class="k">return</span> <span class="n">movie_synopsis</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error extracting long synopsis: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">None</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_extract_year</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">soup</span><span class="p">:</span> <span class="n">BeautifulSoup</span><span class="p">,</span> <span class="n">tconst</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Extracts the movie release year using the IMDb releaseinfo URL.</span>

<span class="sd">        Args:</span>
<span class="sd">            soup (BeautifulSoup): Parsed IMDb movie page.</span>
<span class="sd">            tconst (str): IMDb title ID.</span>

<span class="sd">        Returns:</span>
<span class="sd">            Optional[str]: Release year or fallback message.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># Generate the release info URL dynamically based on tconst</span>
            <span class="n">release_info_href</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;/title/</span><span class="si">{</span><span class="n">tconst</span><span class="si">}</span><span class="s2">/releaseinfo&quot;</span>
            <span class="c1"># Find the anchor tag that links to the release info page</span>
            <span class="n">year_tag</span> <span class="o">=</span> <span class="n">soup</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s2">&quot;a&quot;</span><span class="p">,</span> <span class="p">{</span><span class="s2">&quot;class&quot;</span><span class="p">:</span> <span class="s2">&quot;ipc-link ipc-link--baseAlt ipc-link--inherit-color&quot;</span><span class="p">},</span>
                                 <span class="n">href</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span> <span class="ow">and</span> <span class="n">release_info_href</span> <span class="ow">in</span> <span class="n">x</span><span class="p">)</span>
            <span class="c1"># Extract and return the year if found</span>
            <span class="k">return</span> <span class="n">year_tag</span><span class="o">.</span><span class="n">get_text</span><span class="p">(</span><span class="n">strip</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span> <span class="k">if</span> <span class="n">year_tag</span> <span class="k">else</span> <span class="s2">&quot;Year not found&quot;</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error extracting year for </span><span class="si">{</span><span class="n">tconst</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">None</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_extract_age_rating</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">soup</span><span class="p">:</span> <span class="n">BeautifulSoup</span><span class="p">,</span> <span class="n">tconst</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Extracts the parental age rating.</span>

<span class="sd">        Args:</span>
<span class="sd">            soup (BeautifulSoup): Parsed IMDb movie page.</span>
<span class="sd">            tconst (str): IMDb title ID.</span>

<span class="sd">        Returns:</span>
<span class="sd">            Optional[str]: Age rating or fallback message.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># Generate the parental guide URL dynamically based on tconst</span>
            <span class="n">parental_guide_href</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;/title/</span><span class="si">{</span><span class="n">tconst</span><span class="si">}</span><span class="s2">/parentalguide&quot;</span>
            <span class="c1"># Find the anchor tag that links to the parental guide page</span>
            <span class="n">rating_tag</span> <span class="o">=</span> <span class="n">soup</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s2">&quot;a&quot;</span><span class="p">,</span> <span class="p">{</span><span class="s2">&quot;class&quot;</span><span class="p">:</span> <span class="s2">&quot;ipc-link ipc-link--baseAlt ipc-link--inherit-color&quot;</span><span class="p">},</span>
                                   <span class="n">href</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span> <span class="ow">and</span> <span class="n">parental_guide_href</span> <span class="ow">in</span> <span class="n">x</span><span class="p">)</span>
            <span class="c1"># Extract and return the age rating if found</span>
            <span class="k">return</span> <span class="n">rating_tag</span><span class="o">.</span><span class="n">get_text</span><span class="p">(</span><span class="n">strip</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span> <span class="k">if</span> <span class="n">rating_tag</span> <span class="k">else</span> <span class="s2">&quot;Rating not found&quot;</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error extracting age rating for </span><span class="si">{</span><span class="n">tconst</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">None</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_extract_runtime</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">soup</span><span class="p">:</span> <span class="n">BeautifulSoup</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Extracts the movie runtime.</span>

<span class="sd">        Args:</span>
<span class="sd">            soup (BeautifulSoup): Parsed IMDb movie page.</span>

<span class="sd">        Returns:</span>
<span class="sd">            Optional[str]: Runtime string or fallback.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># Locate the runtime metadata section</span>
            <span class="n">runtime_tag</span> <span class="o">=</span> <span class="n">soup</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s2">&quot;li&quot;</span><span class="p">,</span> <span class="p">{</span><span class="s2">&quot;role&quot;</span><span class="p">:</span> <span class="s2">&quot;presentation&quot;</span><span class="p">,</span> <span class="s2">&quot;class&quot;</span><span class="p">:</span> <span class="s2">&quot;ipc-metadata-list__item&quot;</span><span class="p">,</span>
                                           <span class="s2">&quot;data-testid&quot;</span><span class="p">:</span> <span class="s2">&quot;title-techspec_runtime&quot;</span><span class="p">})</span>
            <span class="c1"># Extract runtime from the correct div container</span>
            <span class="k">if</span> <span class="n">runtime_tag</span><span class="p">:</span>
                <span class="n">runtime_span</span> <span class="o">=</span> <span class="n">runtime_tag</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s2">&quot;div&quot;</span><span class="p">,</span> <span class="p">{</span><span class="s2">&quot;class&quot;</span><span class="p">:</span> <span class="s2">&quot;ipc-metadata-list-item__content-container&quot;</span><span class="p">})</span>
                <span class="k">return</span> <span class="n">runtime_span</span><span class="o">.</span><span class="n">get_text</span><span class="p">(</span><span class="n">strip</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span> <span class="k">if</span> <span class="n">runtime_span</span> <span class="k">else</span> <span class="s2">&quot;Runtime not found&quot;</span>
            <span class="k">return</span> <span class="s2">&quot;Runtime not found&quot;</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error extracting runtime: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">None</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_extract_imdb_rating</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">soup</span><span class="p">:</span> <span class="n">BeautifulSoup</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Extracts the IMDb rating of the movie.</span>

<span class="sd">        Args:</span>
<span class="sd">            soup (BeautifulSoup): Parsed IMDb movie page.</span>

<span class="sd">        Returns:</span>
<span class="sd">            Optional[str]: IMDb rating or fallback.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># Locate the IMDb rating section</span>
            <span class="n">rating_tag</span> <span class="o">=</span> <span class="n">soup</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s2">&quot;div&quot;</span><span class="p">,</span> <span class="p">{</span><span class="s2">&quot;data-testid&quot;</span><span class="p">:</span> <span class="s2">&quot;hero-rating-bar__aggregate-rating__score&quot;</span><span class="p">,</span>
                                           <span class="s2">&quot;class&quot;</span><span class="p">:</span> <span class="s2">&quot;sc-d541859f-2 kxphVf&quot;</span><span class="p">})</span>
            <span class="c1"># Extract rating from the correct span container</span>
            <span class="k">if</span> <span class="n">rating_tag</span><span class="p">:</span>
                <span class="n">rating_span</span> <span class="o">=</span> <span class="n">rating_tag</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s2">&quot;span&quot;</span><span class="p">,</span> <span class="p">{</span><span class="s2">&quot;class&quot;</span><span class="p">:</span> <span class="s2">&quot;sc-d541859f-1 imUuxf&quot;</span><span class="p">})</span>
                <span class="k">return</span> <span class="n">rating_span</span><span class="o">.</span><span class="n">get_text</span><span class="p">(</span><span class="n">strip</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span> <span class="k">if</span> <span class="n">rating_span</span> <span class="k">else</span> <span class="s2">&quot;Rating not found&quot;</span>
            <span class="k">return</span> <span class="s2">&quot;Rating not found&quot;</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error extracting IMDb rating: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">None</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_extract_top_actors</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">soup</span><span class="p">:</span> <span class="n">BeautifulSoup</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Extracts the top 5 actors listed in the cast section.</span>

<span class="sd">        Args:</span>
<span class="sd">            soup (BeautifulSoup): Parsed IMDb movie page.</span>

<span class="sd">        Returns:</span>
<span class="sd">            List[str]: Actor names or fallback.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># Locate the actors section</span>
            <span class="n">actors_section</span> <span class="o">=</span> <span class="n">soup</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s2">&quot;div&quot;</span><span class="p">,</span>
                                       <span class="p">{</span><span class="s2">&quot;class&quot;</span><span class="p">:</span> <span class="s2">&quot;ipc-shoveler ipc-shoveler--base ipc-shoveler--page0 title-cast__grid&quot;</span><span class="p">,</span>
                                        <span class="s2">&quot;role&quot;</span><span class="p">:</span> <span class="s2">&quot;group&quot;</span><span class="p">,</span> <span class="s2">&quot;data-testid&quot;</span><span class="p">:</span> <span class="s2">&quot;shoveler&quot;</span><span class="p">})</span>
            <span class="c1"># Extract all actor items</span>
            <span class="n">actors</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">if</span> <span class="n">actors_section</span><span class="p">:</span>
                <span class="n">actor_items</span> <span class="o">=</span> <span class="n">actors_section</span><span class="o">.</span><span class="n">find_all</span><span class="p">(</span><span class="s2">&quot;a&quot;</span><span class="p">,</span> <span class="p">{</span><span class="s2">&quot;data-testid&quot;</span><span class="p">:</span> <span class="s2">&quot;title-cast-item__actor&quot;</span><span class="p">})</span>
                <span class="n">actors</span> <span class="o">=</span> <span class="p">[</span><span class="n">actor</span><span class="o">.</span><span class="n">get_text</span><span class="p">(</span><span class="n">strip</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span> <span class="k">for</span> <span class="n">actor</span> <span class="ow">in</span> <span class="n">actor_items</span><span class="p">[:</span><span class="mi">5</span><span class="p">]]</span>  <span class="c1"># Extract top 5 actors</span>
            <span class="k">return</span> <span class="n">actors</span> <span class="k">if</span> <span class="n">actors</span> <span class="k">else</span> <span class="p">[</span><span class="s2">&quot;Actors not found&quot;</span><span class="p">]</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error extracting actors: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="p">[</span><span class="s2">&quot;Actors not found&quot;</span><span class="p">]</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_extract_genres</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">soup</span><span class="p">:</span> <span class="n">BeautifulSoup</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Extracts the list of genres from the IMDb movie page.</span>

<span class="sd">        Args:</span>
<span class="sd">            soup (BeautifulSoup): Parsed IMDb movie page.</span>

<span class="sd">        Returns:</span>
<span class="sd">            List[str]: Genres or fallback.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># Locate the genre section</span>
            <span class="n">genre_section</span> <span class="o">=</span> <span class="n">soup</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s2">&quot;div&quot;</span><span class="p">,</span> <span class="p">{</span><span class="s2">&quot;class&quot;</span><span class="p">:</span> <span class="s2">&quot;ipc-chip-list__scroller&quot;</span><span class="p">})</span>
            <span class="c1"># Extract all genre items</span>
            <span class="n">genres</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">if</span> <span class="n">genre_section</span><span class="p">:</span>
                <span class="n">genre_items</span> <span class="o">=</span> <span class="n">genre_section</span><span class="o">.</span><span class="n">find_all</span><span class="p">(</span><span class="s2">&quot;span&quot;</span><span class="p">)</span>  <span class="c1"># Adjust based on structure</span>
                <span class="n">genres</span> <span class="o">=</span> <span class="p">[</span><span class="n">genre</span><span class="o">.</span><span class="n">get_text</span><span class="p">(</span><span class="n">strip</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span> <span class="k">for</span> <span class="n">genre</span> <span class="ow">in</span> <span class="n">genre_items</span><span class="p">]</span>
            <span class="k">return</span> <span class="n">genres</span> <span class="k">if</span> <span class="n">genres</span> <span class="k">else</span> <span class="p">[</span><span class="s2">&quot;Genres not found&quot;</span><span class="p">]</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error extracting genres: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="p">[</span><span class="s2">&quot;Genres not found&quot;</span><span class="p">]</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_extract_poster_url</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">soup</span><span class="p">:</span> <span class="n">BeautifulSoup</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Extracts the movie poster image URL.</span>

<span class="sd">        Args:</span>
<span class="sd">            soup (BeautifulSoup): Parsed IMDb movie page.</span>

<span class="sd">        Returns:</span>
<span class="sd">            Optional[str]: Poster URL or fallback.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># Locate the poster container</span>
            <span class="n">poster_container</span> <span class="o">=</span> <span class="n">soup</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s2">&quot;div&quot;</span><span class="p">,</span> <span class="p">{</span>
                <span class="s2">&quot;class&quot;</span><span class="p">:</span> <span class="s2">&quot;ipc-media ipc-media--poster-27x40 ipc-image-media-ratio--poster-27x40 ipc-media--media-radius ipc-media--baseAlt ipc-media--poster-l ipc-poster__poster-image ipc-media__img&quot;</span><span class="p">})</span>
            <span class="c1"># Extract image tag and its URL</span>
            <span class="k">if</span> <span class="n">poster_container</span><span class="p">:</span>
                <span class="n">img_tag</span> <span class="o">=</span> <span class="n">poster_container</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s2">&quot;img&quot;</span><span class="p">)</span>
                <span class="k">return</span> <span class="n">img_tag</span><span class="p">[</span><span class="s1">&#39;src&#39;</span><span class="p">]</span> <span class="k">if</span> <span class="n">img_tag</span> <span class="ow">and</span> <span class="n">img_tag</span><span class="o">.</span><span class="n">has_attr</span><span class="p">(</span><span class="s1">&#39;src&#39;</span><span class="p">)</span> <span class="k">else</span> <span class="s2">&quot;Poster not found&quot;</span>
            <span class="k">return</span> <span class="s2">&quot;Poster not found&quot;</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error extracting poster URL: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">None</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_extract_short_synopsis</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">soup</span><span class="p">:</span> <span class="n">BeautifulSoup</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Extracts the short synopsis (1-line summary).</span>

<span class="sd">        Args:</span>
<span class="sd">            soup (BeautifulSoup): Parsed IMDb movie page.</span>

<span class="sd">        Returns:</span>
<span class="sd">            Optional[str]: Short synopsis or fallback.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># Locate the short synopsis section</span>
            <span class="n">synopsis_tag</span> <span class="o">=</span> <span class="n">soup</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s2">&quot;span&quot;</span><span class="p">,</span> <span class="p">{</span><span class="s2">&quot;role&quot;</span><span class="p">:</span> <span class="s2">&quot;presentation&quot;</span><span class="p">,</span> <span class="s2">&quot;data-testid&quot;</span><span class="p">:</span> <span class="s2">&quot;plot-l&quot;</span><span class="p">,</span> <span class="s2">&quot;class&quot;</span><span class="p">:</span><span class="s2">&quot;sc-191592d9-1 kBRZRe&quot;</span><span class="p">})</span>
            <span class="c1"># Extract and return the short synopsis</span>
            <span class="k">return</span> <span class="n">synopsis_tag</span><span class="o">.</span><span class="n">get_text</span><span class="p">(</span><span class="n">strip</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span> <span class="k">if</span> <span class="n">synopsis_tag</span> <span class="k">else</span> <span class="s2">&quot;No short sum found&quot;</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error extracting short synopsis: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">None</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_extract_summaries</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">soup</span><span class="p">:</span> <span class="n">BeautifulSoup</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Extracts a list of user-submitted plot summaries.</span>

<span class="sd">        Args:</span>
<span class="sd">            soup (BeautifulSoup): Parsed IMDb plot summary page.</span>

<span class="sd">        Returns:</span>
<span class="sd">            List[str]: Plot summaries or fallback.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">summaries_section</span> <span class="o">=</span> <span class="n">soup</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s2">&quot;div&quot;</span><span class="p">,</span> <span class="p">{</span><span class="s2">&quot;data-testid&quot;</span><span class="p">:</span> <span class="s2">&quot;sub-section-summaries&quot;</span><span class="p">})</span>

            <span class="n">summaries</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">if</span> <span class="n">summaries_section</span><span class="p">:</span>
                <span class="n">summary_items</span> <span class="o">=</span> <span class="n">summaries_section</span><span class="o">.</span><span class="n">find_all</span><span class="p">(</span><span class="s2">&quot;li&quot;</span><span class="p">)</span>  <span class="c1"># Adjust based on IMDb structure</span>
                <span class="n">summaries</span> <span class="o">=</span> <span class="p">[</span><span class="n">summary</span><span class="o">.</span><span class="n">get_text</span><span class="p">(</span><span class="n">strip</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span> <span class="k">for</span> <span class="n">summary</span> <span class="ow">in</span> <span class="n">summary_items</span><span class="p">]</span>

            <span class="k">return</span> <span class="n">summaries</span> <span class="k">if</span> <span class="n">summaries</span> <span class="k">else</span> <span class="p">[</span><span class="s2">&quot;No summaries found&quot;</span><span class="p">]</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error extracting summaries: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="p">[</span><span class="s2">&quot;No summaries found&quot;</span><span class="p">]</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_extract_text</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">element</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Tag</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Extracts text from a BeautifulSoup element.</span>

<span class="sd">        Args:</span>
<span class="sd">            element (Tag): A BeautifulSoup element.</span>

<span class="sd">        Returns:</span>
<span class="sd">            Optional[str]: Cleaned text or None.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">element</span><span class="o">.</span><span class="n">get_text</span><span class="p">(</span><span class="n">strip</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span> <span class="k">if</span> <span class="n">element</span> <span class="k">else</span> <span class="kc">None</span>

    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">crawl_movies</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">num_movies</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Orchestrates crawling multiple IMDb movies concurrently and writes results to CSV in batches.</span>

<span class="sd">        Args:</span>
<span class="sd">            num_movies (int, optional): Maximum number of movies to crawl. Defaults to all.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">init_session</span><span class="p">()</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Reading movie IDs from TSV...&quot;</span><span class="p">)</span>
            <span class="n">movie_ids</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_movies_from_tsv</span><span class="p">()</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">movie_ids</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;No movies found in TSV!&quot;</span><span class="p">)</span>
                <span class="k">return</span>
            <span class="c1"># Apply optional movie limit</span>
            <span class="k">if</span> <span class="n">num_movies</span><span class="p">:</span>
                <span class="n">movie_ids</span> <span class="o">=</span> <span class="n">movie_ids</span><span class="p">[:</span><span class="n">num_movies</span><span class="p">]</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Found </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">movie_ids</span><span class="p">)</span><span class="si">}</span><span class="s2"> movies to crawl&quot;</span><span class="p">)</span>
            <span class="c1"># Set up concurrency control</span>
            <span class="n">semaphore</span> <span class="o">=</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">Semaphore</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">concurrent_requests</span><span class="p">)</span>
            <span class="n">all_movie_data</span> <span class="o">=</span> <span class="p">[]</span>  <span class="c1"># Temporary storage for batch processing</span>
            <span class="n">csv_file</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">output_dir</span> <span class="o">/</span> <span class="n">OUTPUT_FILE</span>
            <span class="c1"># Track CSV file existence for header management</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">csv_exists</span> <span class="o">=</span> <span class="n">csv_file</span><span class="o">.</span><span class="n">exists</span><span class="p">()</span>

            <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">crawl_with_semaphore</span><span class="p">(</span><span class="n">tcont</span><span class="p">):</span>
                <span class="k">nonlocal</span> <span class="n">all_movie_data</span>
                <span class="k">async</span> <span class="k">with</span> <span class="n">semaphore</span><span class="p">:</span>
                    <span class="n">movie_data</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">extract_movie_data</span><span class="p">(</span><span class="n">tcont</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">movie_data</span><span class="p">:</span>
                        <span class="n">all_movie_data</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">movie_data</span><span class="p">)</span>
                        <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">record_processed_id</span><span class="p">(</span><span class="n">tcont</span><span class="p">)</span>
                        <span class="c1"># Batch write to CSV every 100 movies</span>
                        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">all_movie_data</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">100</span><span class="p">:</span>
                            <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">all_movie_data</span><span class="p">)</span>
                            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">csv_exists</span><span class="p">:</span>
                                <span class="n">df</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">csv_file</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;a&#39;</span><span class="p">,</span> <span class="n">header</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
                            <span class="k">else</span><span class="p">:</span>
                                <span class="n">df</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">csv_file</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">csv_exists</span> <span class="o">=</span> <span class="kc">True</span>
                            <span class="n">all_movie_data</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
                            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Wrote batch of </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="p">)</span><span class="si">}</span><span class="s2"> movies to CSV&quot;</span><span class="p">)</span>
            <span class="c1"># Create and execute crawling tasks</span>
            <span class="n">tasks</span> <span class="o">=</span> <span class="p">[</span><span class="n">crawl_with_semaphore</span><span class="p">(</span><span class="n">tcont</span><span class="p">)</span> <span class="k">for</span> <span class="n">tcont</span> <span class="ow">in</span> <span class="n">movie_ids</span><span class="p">]</span>
            <span class="c1"># Monitor progress</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">task</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">asyncio</span><span class="o">.</span><span class="n">as_completed</span><span class="p">(</span><span class="n">tasks</span><span class="p">)):</span>
                <span class="k">await</span> <span class="n">task</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Progress: </span><span class="si">{</span><span class="n">i</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">movie_ids</span><span class="p">)</span><span class="si">}</span><span class="s2"> movies processed&quot;</span><span class="p">)</span>
            <span class="c1"># Handle any remaining movies in the batch</span>
            <span class="k">if</span> <span class="n">all_movie_data</span><span class="p">:</span>
                <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">all_movie_data</span><span class="p">)</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">csv_exists</span><span class="p">:</span>
                    <span class="n">df</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">csv_file</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;a&#39;</span><span class="p">,</span> <span class="n">header</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">df</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">csv_file</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Wrote final batch of </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="p">)</span><span class="si">}</span><span class="s2"> movies to CSV&quot;</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error during crawling: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">close_session</span><span class="p">()</span>

    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">close_session</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">session</span><span class="p">:</span>
            <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">session</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Session closed.&quot;</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>

  

  <div class="doc doc-children">










<div class="doc doc-object doc-function">




<h3 id="app.pipeline.extract_movie_data.IMDbCrawler.crawl_movies" class="doc doc-heading">
          <code class="highlight language-python"><span class="n">crawl_movies</span><span class="p">(</span><span class="n">num_movies</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>
  
  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-async"><code>async</code></small>
  </span>

</h3>


  <div class="doc doc-contents ">
  
      <p>Orchestrates crawling multiple IMDb movies concurrently and writes results to CSV in batches.</p>



  <p><strong>Parameters:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Name</th>
        <th>Type</th>
        <th>Description</th>
        <th>Default</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td><code>num_movies</code></td>
          <td>
                <code>int</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>Maximum number of movies to crawl. Defaults to all.</p>
            </div>
          </td>
          <td>
                <code>None</code>
          </td>
        </tr>
    </tbody>
  </table>

          <details class="quote">
            <summary>Source code in <code>app/pipeline/extract_movie_data.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">447</span>
<span class="normal">448</span>
<span class="normal">449</span>
<span class="normal">450</span>
<span class="normal">451</span>
<span class="normal">452</span>
<span class="normal">453</span>
<span class="normal">454</span>
<span class="normal">455</span>
<span class="normal">456</span>
<span class="normal">457</span>
<span class="normal">458</span>
<span class="normal">459</span>
<span class="normal">460</span>
<span class="normal">461</span>
<span class="normal">462</span>
<span class="normal">463</span>
<span class="normal">464</span>
<span class="normal">465</span>
<span class="normal">466</span>
<span class="normal">467</span>
<span class="normal">468</span>
<span class="normal">469</span>
<span class="normal">470</span>
<span class="normal">471</span>
<span class="normal">472</span>
<span class="normal">473</span>
<span class="normal">474</span>
<span class="normal">475</span>
<span class="normal">476</span>
<span class="normal">477</span>
<span class="normal">478</span>
<span class="normal">479</span>
<span class="normal">480</span>
<span class="normal">481</span>
<span class="normal">482</span>
<span class="normal">483</span>
<span class="normal">484</span>
<span class="normal">485</span>
<span class="normal">486</span>
<span class="normal">487</span>
<span class="normal">488</span>
<span class="normal">489</span>
<span class="normal">490</span>
<span class="normal">491</span>
<span class="normal">492</span>
<span class="normal">493</span>
<span class="normal">494</span>
<span class="normal">495</span>
<span class="normal">496</span>
<span class="normal">497</span>
<span class="normal">498</span>
<span class="normal">499</span>
<span class="normal">500</span>
<span class="normal">501</span>
<span class="normal">502</span>
<span class="normal">503</span>
<span class="normal">504</span>
<span class="normal">505</span>
<span class="normal">506</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">crawl_movies</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">num_movies</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Orchestrates crawling multiple IMDb movies concurrently and writes results to CSV in batches.</span>

<span class="sd">    Args:</span>
<span class="sd">        num_movies (int, optional): Maximum number of movies to crawl. Defaults to all.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">init_session</span><span class="p">()</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Reading movie IDs from TSV...&quot;</span><span class="p">)</span>
        <span class="n">movie_ids</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_movies_from_tsv</span><span class="p">()</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">movie_ids</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;No movies found in TSV!&quot;</span><span class="p">)</span>
            <span class="k">return</span>
        <span class="c1"># Apply optional movie limit</span>
        <span class="k">if</span> <span class="n">num_movies</span><span class="p">:</span>
            <span class="n">movie_ids</span> <span class="o">=</span> <span class="n">movie_ids</span><span class="p">[:</span><span class="n">num_movies</span><span class="p">]</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Found </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">movie_ids</span><span class="p">)</span><span class="si">}</span><span class="s2"> movies to crawl&quot;</span><span class="p">)</span>
        <span class="c1"># Set up concurrency control</span>
        <span class="n">semaphore</span> <span class="o">=</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">Semaphore</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">concurrent_requests</span><span class="p">)</span>
        <span class="n">all_movie_data</span> <span class="o">=</span> <span class="p">[]</span>  <span class="c1"># Temporary storage for batch processing</span>
        <span class="n">csv_file</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">output_dir</span> <span class="o">/</span> <span class="n">OUTPUT_FILE</span>
        <span class="c1"># Track CSV file existence for header management</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">csv_exists</span> <span class="o">=</span> <span class="n">csv_file</span><span class="o">.</span><span class="n">exists</span><span class="p">()</span>

        <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">crawl_with_semaphore</span><span class="p">(</span><span class="n">tcont</span><span class="p">):</span>
            <span class="k">nonlocal</span> <span class="n">all_movie_data</span>
            <span class="k">async</span> <span class="k">with</span> <span class="n">semaphore</span><span class="p">:</span>
                <span class="n">movie_data</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">extract_movie_data</span><span class="p">(</span><span class="n">tcont</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">movie_data</span><span class="p">:</span>
                    <span class="n">all_movie_data</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">movie_data</span><span class="p">)</span>
                    <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">record_processed_id</span><span class="p">(</span><span class="n">tcont</span><span class="p">)</span>
                    <span class="c1"># Batch write to CSV every 100 movies</span>
                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">all_movie_data</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">100</span><span class="p">:</span>
                        <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">all_movie_data</span><span class="p">)</span>
                        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">csv_exists</span><span class="p">:</span>
                            <span class="n">df</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">csv_file</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;a&#39;</span><span class="p">,</span> <span class="n">header</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">df</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">csv_file</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">csv_exists</span> <span class="o">=</span> <span class="kc">True</span>
                        <span class="n">all_movie_data</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Wrote batch of </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="p">)</span><span class="si">}</span><span class="s2"> movies to CSV&quot;</span><span class="p">)</span>
        <span class="c1"># Create and execute crawling tasks</span>
        <span class="n">tasks</span> <span class="o">=</span> <span class="p">[</span><span class="n">crawl_with_semaphore</span><span class="p">(</span><span class="n">tcont</span><span class="p">)</span> <span class="k">for</span> <span class="n">tcont</span> <span class="ow">in</span> <span class="n">movie_ids</span><span class="p">]</span>
        <span class="c1"># Monitor progress</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">task</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">asyncio</span><span class="o">.</span><span class="n">as_completed</span><span class="p">(</span><span class="n">tasks</span><span class="p">)):</span>
            <span class="k">await</span> <span class="n">task</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Progress: </span><span class="si">{</span><span class="n">i</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">movie_ids</span><span class="p">)</span><span class="si">}</span><span class="s2"> movies processed&quot;</span><span class="p">)</span>
        <span class="c1"># Handle any remaining movies in the batch</span>
        <span class="k">if</span> <span class="n">all_movie_data</span><span class="p">:</span>
            <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">all_movie_data</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">csv_exists</span><span class="p">:</span>
                <span class="n">df</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">csv_file</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;a&#39;</span><span class="p">,</span> <span class="n">header</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">df</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">csv_file</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Wrote final batch of </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="p">)</span><span class="si">}</span><span class="s2"> movies to CSV&quot;</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error during crawling: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="k">finally</span><span class="p">:</span>
        <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">close_session</span><span class="p">()</span>
</code></pre></div></td></tr></table></div>
          </details>
  </div>

</div>


<div class="doc doc-object doc-function">




<h3 id="app.pipeline.extract_movie_data.IMDbCrawler.extract_movie_data" class="doc doc-heading">
          <code class="highlight language-python"><span class="n">extract_movie_data</span><span class="p">(</span><span class="n">tconst</span><span class="p">)</span></code>
  
  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-async"><code>async</code></small>
  </span>

</h3>


  <div class="doc doc-contents ">
  
      <p>Extracts full metadata and synopsis info from IMDb for a single title.</p>



  <p><strong>Parameters:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Name</th>
        <th>Type</th>
        <th>Description</th>
        <th>Default</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td><code>tconst</code></td>
          <td>
                <code>str</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>IMDb title ID.</p>
            </div>
          </td>
          <td>
              <em>required</em>
          </td>
        </tr>
    </tbody>
  </table>



  <p><strong>Returns:</strong></p>
  <table>
    <thead>
      <tr>
<th>Name</th>        <th>Type</th>
        <th>Description</th>
      </tr>
    </thead>
    <tbody>
        <tr>
<td><code>Dict</code></td>          <td>
                <code><span title="typing.Dict">Dict</span>[str, <span title="typing.Union">Union</span>[str, <span title="typing.List">List</span>[str], None]]</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>Extracted movie data.</p>
            </div>
          </td>
        </tr>
    </tbody>
  </table>

          <details class="quote">
            <summary>Source code in <code>app/pipeline/extract_movie_data.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">126</span>
<span class="normal">127</span>
<span class="normal">128</span>
<span class="normal">129</span>
<span class="normal">130</span>
<span class="normal">131</span>
<span class="normal">132</span>
<span class="normal">133</span>
<span class="normal">134</span>
<span class="normal">135</span>
<span class="normal">136</span>
<span class="normal">137</span>
<span class="normal">138</span>
<span class="normal">139</span>
<span class="normal">140</span>
<span class="normal">141</span>
<span class="normal">142</span>
<span class="normal">143</span>
<span class="normal">144</span>
<span class="normal">145</span>
<span class="normal">146</span>
<span class="normal">147</span>
<span class="normal">148</span>
<span class="normal">149</span>
<span class="normal">150</span>
<span class="normal">151</span>
<span class="normal">152</span>
<span class="normal">153</span>
<span class="normal">154</span>
<span class="normal">155</span>
<span class="normal">156</span>
<span class="normal">157</span>
<span class="normal">158</span>
<span class="normal">159</span>
<span class="normal">160</span>
<span class="normal">161</span>
<span class="normal">162</span>
<span class="normal">163</span>
<span class="normal">164</span>
<span class="normal">165</span>
<span class="normal">166</span>
<span class="normal">167</span>
<span class="normal">168</span>
<span class="normal">169</span>
<span class="normal">170</span>
<span class="normal">171</span>
<span class="normal">172</span>
<span class="normal">173</span>
<span class="normal">174</span>
<span class="normal">175</span>
<span class="normal">176</span>
<span class="normal">177</span>
<span class="normal">178</span>
<span class="normal">179</span>
<span class="normal">180</span>
<span class="normal">181</span>
<span class="normal">182</span>
<span class="normal">183</span>
<span class="normal">184</span>
<span class="normal">185</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">extract_movie_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tconst</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span> <span class="kc">None</span><span class="p">]]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Extracts full metadata and synopsis info from IMDb for a single title.</span>

<span class="sd">    Args:</span>
<span class="sd">        tconst (str): IMDb title ID.</span>

<span class="sd">    Returns:</span>
<span class="sd">        Dict: Extracted movie data.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Initialize movie data structure with metadata</span>
    <span class="n">movie_data</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;tconst&#39;</span><span class="p">:</span> <span class="n">tconst</span><span class="p">,</span>
        <span class="s1">&#39;crawl_timestamp&#39;</span><span class="p">:</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">isoformat</span><span class="p">()</span>
    <span class="p">}</span>
    <span class="c1"># Construct main movie page URL</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">tconst</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;/title/&#39;</span><span class="p">):</span>
        <span class="n">main_url</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;https://www.imdb.com/title/</span><span class="si">{</span><span class="n">tconst</span><span class="si">}</span><span class="s2">/&quot;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">main_url</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;https://www.imdb.com</span><span class="si">{</span><span class="n">tconst</span><span class="si">}</span><span class="s2">&quot;</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Fetching movie data from: </span><span class="si">{</span><span class="n">main_url</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="c1"># Fetch and process main page</span>
        <span class="k">async</span> <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">main_url</span><span class="p">)</span> <span class="k">as</span> <span class="n">response</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">response</span><span class="o">.</span><span class="n">status</span> <span class="o">==</span> <span class="mi">200</span><span class="p">:</span>
                <span class="n">html</span> <span class="o">=</span> <span class="k">await</span> <span class="n">response</span><span class="o">.</span><span class="n">text</span><span class="p">()</span>
                <span class="n">soup</span> <span class="o">=</span> <span class="n">BeautifulSoup</span><span class="p">(</span><span class="n">html</span><span class="p">,</span> <span class="s1">&#39;html.parser&#39;</span><span class="p">)</span>
                <span class="c1"># Extract all available data points</span>
                <span class="n">movie_data</span><span class="o">.</span><span class="n">update</span><span class="p">({</span>
                    <span class="s1">&#39;movie_title&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_extract_title</span><span class="p">(</span><span class="n">soup</span><span class="p">),</span>
                    <span class="s1">&#39;movie_year&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_extract_year</span><span class="p">(</span><span class="n">soup</span><span class="p">,</span> <span class="n">tconst</span><span class="p">),</span>
                    <span class="s1">&#39;age_rating&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_extract_age_rating</span><span class="p">(</span><span class="n">soup</span><span class="p">,</span> <span class="n">tconst</span><span class="p">),</span>
                    <span class="s1">&#39;duration&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_extract_runtime</span><span class="p">(</span><span class="n">soup</span><span class="p">),</span>
                    <span class="s1">&#39;imdb_rating&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_extract_imdb_rating</span><span class="p">(</span><span class="n">soup</span><span class="p">),</span>
                    <span class="s1">&#39;short_synopsis&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_extract_short_synopsis</span><span class="p">(</span><span class="n">soup</span><span class="p">),</span>
                    <span class="s1">&#39;top_5_actors&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_extract_top_actors</span><span class="p">(</span><span class="n">soup</span><span class="p">),</span>
                    <span class="s1">&#39;genres&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_extract_genres</span><span class="p">(</span><span class="n">soup</span><span class="p">),</span>
                    <span class="s1">&#39;poster_url&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_extract_poster_url</span><span class="p">(</span><span class="n">soup</span><span class="p">),</span>
                    <span class="s1">&#39;summaries&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_extract_summaries</span><span class="p">(</span><span class="n">soup</span><span class="p">),</span>
                    <span class="s1">&#39;long_synopsis&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_extract_long_synopsis</span><span class="p">(</span><span class="n">soup</span><span class="p">),</span>
                <span class="p">})</span>
                <span class="c1"># Implement rate limiting</span>
                <span class="k">await</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="n">random</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">min_delay</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_delay</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Failed to get movie </span><span class="si">{</span><span class="n">tconst</span><span class="si">}</span><span class="s2">: Status </span><span class="si">{</span><span class="n">response</span><span class="o">.</span><span class="n">status</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error extracting main data for </span><span class="si">{</span><span class="n">tconst</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="c1"># Fetch and process plot summary page</span>
    <span class="n">plot_url</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;https://www.imdb.com/title/</span><span class="si">{</span><span class="n">tconst</span><span class="si">}</span><span class="s2">/plotsummary/&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">async</span> <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">plot_url</span><span class="p">)</span> <span class="k">as</span> <span class="n">response</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">response</span><span class="o">.</span><span class="n">status</span> <span class="o">==</span> <span class="mi">200</span><span class="p">:</span>
                <span class="n">html</span> <span class="o">=</span> <span class="k">await</span> <span class="n">response</span><span class="o">.</span><span class="n">text</span><span class="p">()</span>
                <span class="n">soup</span> <span class="o">=</span> <span class="n">BeautifulSoup</span><span class="p">(</span><span class="n">html</span><span class="p">,</span> <span class="s1">&#39;html.parser&#39;</span><span class="p">)</span>
                <span class="n">movie_data</span><span class="p">[</span><span class="s1">&#39;long_synopsis&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_extract_long_synopsis</span><span class="p">(</span><span class="n">soup</span><span class="p">)</span>
                <span class="n">movie_data</span><span class="p">[</span><span class="s1">&#39;summaries&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_extract_summaries</span><span class="p">(</span><span class="n">soup</span><span class="p">)</span>
                <span class="k">await</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="n">random</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">min_delay</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_delay</span><span class="p">))</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error extracting plot data for </span><span class="si">{</span><span class="n">tconst</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">movie_data</span>
</code></pre></div></td></tr></table></div>
          </details>
  </div>

</div>


<div class="doc doc-object doc-function">




<h3 id="app.pipeline.extract_movie_data.IMDbCrawler.get_movies_from_tsv" class="doc doc-heading">
          <code class="highlight language-python"><span class="n">get_movies_from_tsv</span><span class="p">(</span><span class="n">tsv_file</span><span class="o">=</span><span class="n">TSV_FILENAME</span><span class="p">)</span></code>
  
  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-async"><code>async</code></small>
  </span>

</h3>


  <div class="doc doc-contents ">
  
      <p>Reads movie IDs from a TSV file and filters out already processed IDs.</p>



  <p><strong>Parameters:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Name</th>
        <th>Type</th>
        <th>Description</th>
        <th>Default</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td><code>tsv_file</code></td>
          <td>
                <code>str</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>Path to the input TSV file.</p>
            </div>
          </td>
          <td>
                <code><span title="config.TSV_FILENAME">TSV_FILENAME</span></code>
          </td>
        </tr>
    </tbody>
  </table>



  <p><strong>Returns:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Type</th>
        <th>Description</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td>
                <code><span title="typing.List">List</span>[str]</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>List[str]: List of IMDb movie IDs to process.</p>
            </div>
          </td>
        </tr>
    </tbody>
  </table>

          <details class="quote">
            <summary>Source code in <code>app/pipeline/extract_movie_data.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 78</span>
<span class="normal"> 79</span>
<span class="normal"> 80</span>
<span class="normal"> 81</span>
<span class="normal"> 82</span>
<span class="normal"> 83</span>
<span class="normal"> 84</span>
<span class="normal"> 85</span>
<span class="normal"> 86</span>
<span class="normal"> 87</span>
<span class="normal"> 88</span>
<span class="normal"> 89</span>
<span class="normal"> 90</span>
<span class="normal"> 91</span>
<span class="normal"> 92</span>
<span class="normal"> 93</span>
<span class="normal"> 94</span>
<span class="normal"> 95</span>
<span class="normal"> 96</span>
<span class="normal"> 97</span>
<span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span>
<span class="normal">102</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">get_movies_from_tsv</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tsv_file</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">TSV_FILENAME</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Reads movie IDs from a TSV file and filters out already processed IDs.</span>

<span class="sd">    Args:</span>
<span class="sd">        tsv_file (str): Path to the input TSV file.</span>

<span class="sd">    Returns:</span>
<span class="sd">        List[str]: List of IMDb movie IDs to process.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="c1"># Read the input TSV file</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">tsv_file</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="c1"># Check for and handle already processed movies</span>
        <span class="n">processed_file</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">output_dir</span> <span class="o">/</span> <span class="n">PROCESSED_IDS</span>
        <span class="k">if</span> <span class="n">processed_file</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
            <span class="n">processed_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">processed_file</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="n">processed_ids</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">processed_df</span><span class="p">[</span><span class="s1">&#39;tconst&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">tolist</span><span class="p">())</span>
            <span class="c1"># Remove already processed movies from the queue</span>
            <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="o">~</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;tconst&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">processed_ids</span><span class="p">)]</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Found </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="p">)</span><span class="si">}</span><span class="s2"> movies to process&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;tconst&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error reading TSV file: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">[]</span>
</code></pre></div></td></tr></table></div>
          </details>
  </div>

</div>


<div class="doc doc-object doc-function">




<h3 id="app.pipeline.extract_movie_data.IMDbCrawler.init_session" class="doc doc-heading">
          <code class="highlight language-python"><span class="n">init_session</span><span class="p">()</span></code>
  
  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-async"><code>async</code></small>
  </span>

</h3>


  <div class="doc doc-contents ">
  
      <p>Initializes the aiohttp session with SSL context.</p>

          <details class="quote">
            <summary>Source code in <code>app/pipeline/extract_movie_data.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">61</span>
<span class="normal">62</span>
<span class="normal">63</span>
<span class="normal">64</span>
<span class="normal">65</span>
<span class="normal">66</span>
<span class="normal">67</span>
<span class="normal">68</span>
<span class="normal">69</span>
<span class="normal">70</span>
<span class="normal">71</span>
<span class="normal">72</span>
<span class="normal">73</span>
<span class="normal">74</span>
<span class="normal">75</span>
<span class="normal">76</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">init_session</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Initializes the aiohttp session with SSL context.&quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">session</span><span class="p">:</span>
        <span class="c1"># Create SSL context with proper certificate verification</span>
        <span class="n">ssl_context</span> <span class="o">=</span> <span class="n">ssl</span><span class="o">.</span><span class="n">create_default_context</span><span class="p">(</span><span class="n">cafile</span><span class="o">=</span><span class="n">certifi</span><span class="o">.</span><span class="n">where</span><span class="p">())</span>
        <span class="c1"># Configure TCP connector with SSL settings</span>
        <span class="n">connector</span> <span class="o">=</span> <span class="n">aiohttp</span><span class="o">.</span><span class="n">TCPConnector</span><span class="p">(</span>
            <span class="n">ssl</span><span class="o">=</span><span class="n">ssl_context</span><span class="p">,</span>
            <span class="n">verify_ssl</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="n">force_close</span><span class="o">=</span><span class="kc">True</span>  <span class="c1"># Ensure connections are closed after use</span>
        <span class="p">)</span>
        <span class="c1"># Create the client session</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">session</span> <span class="o">=</span> <span class="n">aiohttp</span><span class="o">.</span><span class="n">ClientSession</span><span class="p">(</span>
            <span class="n">headers</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">headers</span><span class="p">,</span>
            <span class="n">connector</span><span class="o">=</span><span class="n">connector</span>
        <span class="p">)</span>
</code></pre></div></td></tr></table></div>
          </details>
  </div>

</div>


<div class="doc doc-object doc-function">




<h3 id="app.pipeline.extract_movie_data.IMDbCrawler.record_processed_id" class="doc doc-heading">
          <code class="highlight language-python"><span class="n">record_processed_id</span><span class="p">(</span><span class="n">tconst</span><span class="p">)</span></code>
  
  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-async"><code>async</code></small>
  </span>

</h3>


  <div class="doc doc-contents ">
  
      <p>Records a processed IMDb ID into a TSV log with timestamp.</p>



  <p><strong>Parameters:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Name</th>
        <th>Type</th>
        <th>Description</th>
        <th>Default</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td><code>tconst</code></td>
          <td>
                <code>str</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>IMDb title ID.</p>
            </div>
          </td>
          <td>
              <em>required</em>
          </td>
        </tr>
    </tbody>
  </table>

          <details class="quote">
            <summary>Source code in <code>app/pipeline/extract_movie_data.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">104</span>
<span class="normal">105</span>
<span class="normal">106</span>
<span class="normal">107</span>
<span class="normal">108</span>
<span class="normal">109</span>
<span class="normal">110</span>
<span class="normal">111</span>
<span class="normal">112</span>
<span class="normal">113</span>
<span class="normal">114</span>
<span class="normal">115</span>
<span class="normal">116</span>
<span class="normal">117</span>
<span class="normal">118</span>
<span class="normal">119</span>
<span class="normal">120</span>
<span class="normal">121</span>
<span class="normal">122</span>
<span class="normal">123</span>
<span class="normal">124</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">record_processed_id</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tconst</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Records a processed IMDb ID into a TSV log with timestamp.</span>

<span class="sd">    Args:</span>
<span class="sd">        tconst (str): IMDb title ID.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">processed_file</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">output_dir</span> <span class="o">/</span> <span class="n">PROCESSED_IDS</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="c1"># Create DataFrame with movie ID and timestamp</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span>
            <span class="s1">&#39;tconst&#39;</span><span class="p">:</span> <span class="p">[</span><span class="n">tconst</span><span class="p">],</span>
            <span class="s1">&#39;processed_time&#39;</span><span class="p">:</span> <span class="p">[</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">isoformat</span><span class="p">()]</span>
        <span class="p">})</span>
        <span class="c1"># Append or create the processed IDs file</span>
        <span class="k">if</span> <span class="n">processed_file</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
            <span class="n">df</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">processed_file</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;a&#39;</span><span class="p">,</span> <span class="n">header</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">df</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">processed_file</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error recording processed ID: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
          </details>
  </div>

</div>



  </div>

  </div>

</div>



<div class="doc doc-object doc-function">




<h2 id="app.pipeline.extract_movie_data.run_crawler" class="doc doc-heading">
          <code class="highlight language-python"><span class="n">run_crawler</span><span class="p">(</span><span class="n">output_dir</span><span class="o">=</span><span class="s1">&#39;imdb_data&#39;</span><span class="p">,</span> <span class="n">tsv_file</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">num_movies</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span></code>
  
  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-async"><code>async</code></small>
  </span>

</h2>


  <div class="doc doc-contents ">
  
      <p>Entrypoint to run the IMDbCrawler with optional input and batch limits.</p>



  <p><strong>Parameters:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Name</th>
        <th>Type</th>
        <th>Description</th>
        <th>Default</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td><code>output_dir</code></td>
          <td>
                <code>str</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>Output directory path.</p>
            </div>
          </td>
          <td>
                <code>&#39;imdb_data&#39;</code>
          </td>
        </tr>
        <tr>
          <td><code>tsv_file</code></td>
          <td>
                <code>str</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>Path to custom TSV file of movie IDs.</p>
            </div>
          </td>
          <td>
                <code>None</code>
          </td>
        </tr>
        <tr>
          <td><code>num_movies</code></td>
          <td>
                <code>int</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>Number of movies to crawl (0 = all).</p>
            </div>
          </td>
          <td>
                <code>0</code>
          </td>
        </tr>
    </tbody>
  </table>

          <details class="quote">
            <summary>Source code in <code>app/pipeline/extract_movie_data.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">515</span>
<span class="normal">516</span>
<span class="normal">517</span>
<span class="normal">518</span>
<span class="normal">519</span>
<span class="normal">520</span>
<span class="normal">521</span>
<span class="normal">522</span>
<span class="normal">523</span>
<span class="normal">524</span>
<span class="normal">525</span>
<span class="normal">526</span>
<span class="normal">527</span>
<span class="normal">528</span>
<span class="normal">529</span>
<span class="normal">530</span>
<span class="normal">531</span>
<span class="normal">532</span>
<span class="normal">533</span>
<span class="normal">534</span>
<span class="normal">535</span>
<span class="normal">536</span>
<span class="normal">537</span>
<span class="normal">538</span>
<span class="normal">539</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">run_crawler</span><span class="p">(</span><span class="n">output_dir</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;imdb_data&quot;</span><span class="p">,</span> <span class="n">tsv_file</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">num_movies</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Entrypoint to run the IMDbCrawler with optional input and batch limits.</span>

<span class="sd">    Args:</span>
<span class="sd">        output_dir (str): Output directory path.</span>
<span class="sd">        tsv_file (str, optional): Path to custom TSV file of movie IDs.</span>
<span class="sd">        num_movies (int): Number of movies to crawl (0 = all).</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">crawler</span> <span class="o">=</span> <span class="n">IMDbCrawler</span><span class="p">(</span>
            <span class="n">output_dir</span><span class="o">=</span><span class="n">output_dir</span><span class="p">,</span>
            <span class="n">min_delay</span><span class="o">=</span><span class="mf">2.0</span><span class="p">,</span>
            <span class="n">max_delay</span><span class="o">=</span><span class="mf">4.0</span><span class="p">,</span>
            <span class="n">concurrent_requests</span><span class="o">=</span><span class="mi">3</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="n">tsv_file</span><span class="p">:</span>
            <span class="n">crawler</span><span class="o">.</span><span class="n">tsv_file</span> <span class="o">=</span> <span class="n">tsv_file</span>  <span class="c1"># Optional override</span>
        <span class="k">await</span> <span class="n">crawler</span><span class="o">.</span><span class="n">crawl_movies</span><span class="p">(</span><span class="n">num_movies</span><span class="o">=</span><span class="n">num_movies</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Movie crawl complete.&quot;</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error running crawler: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="k">finally</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">crawler</span><span class="o">.</span><span class="n">session</span><span class="p">:</span>
            <span class="k">await</span> <span class="n">crawler</span><span class="o">.</span><span class="n">close_session</span><span class="p">()</span>
</code></pre></div></td></tr></table></div>
          </details>
  </div>

</div>



  </div>

  </div>

</div>

<div class="doc doc-object doc-module">



<a id="app.pipeline.clean_synopsis"></a>
  <div class="doc doc-contents first">

  

  <div class="doc doc-children">










<div class="doc doc-object doc-function">




<h2 id="app.pipeline.clean_synopsis.clean_romance_synopsis" class="doc doc-heading">
          <code class="highlight language-python"><span class="n">clean_romance_synopsis</span><span class="p">(</span><span class="n">input_csv</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">output_csv</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>

</h2>


  <div class="doc doc-contents ">
  
      <p>Cleans a CSV file containing romance movie synopses by removing rows with missing data
and processing the summaries column. The cleaned data is saved to an Excel file.</p>



  <p><strong>Parameters:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Name</th>
        <th>Type</th>
        <th>Description</th>
        <th>Default</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td><code>input_csv</code></td>
          <td>
                <code>str</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>Path to the input CSV file containing the full movie data.
             Default is "imdb_data/romance_newbatch.csv".</p>
            </div>
          </td>
          <td>
                <code>None</code>
          </td>
        </tr>
        <tr>
          <td><code>output_csv</code></td>
          <td>
                <code>str</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>Path to the output CSV file where the cleaned data will be saved.
                Default is "imdb_data/romance_full_cleaned.csv".</p>
            </div>
          </td>
          <td>
                <code>None</code>
          </td>
        </tr>
    </tbody>
  </table>



  <p><strong>Returns:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Type</th>
        <th>Description</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td>
                <code>None</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>None</p>
            </div>
          </td>
        </tr>
    </tbody>
  </table>

          <details class="quote">
            <summary>Source code in <code>app/pipeline/clean_synopsis.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span>
<span class="normal">17</span>
<span class="normal">18</span>
<span class="normal">19</span>
<span class="normal">20</span>
<span class="normal">21</span>
<span class="normal">22</span>
<span class="normal">23</span>
<span class="normal">24</span>
<span class="normal">25</span>
<span class="normal">26</span>
<span class="normal">27</span>
<span class="normal">28</span>
<span class="normal">29</span>
<span class="normal">30</span>
<span class="normal">31</span>
<span class="normal">32</span>
<span class="normal">33</span>
<span class="normal">34</span>
<span class="normal">35</span>
<span class="normal">36</span>
<span class="normal">37</span>
<span class="normal">38</span>
<span class="normal">39</span>
<span class="normal">40</span>
<span class="normal">41</span>
<span class="normal">42</span>
<span class="normal">43</span>
<span class="normal">44</span>
<span class="normal">45</span>
<span class="normal">46</span>
<span class="normal">47</span>
<span class="normal">48</span>
<span class="normal">49</span>
<span class="normal">50</span>
<span class="normal">51</span>
<span class="normal">52</span>
<span class="normal">53</span>
<span class="normal">54</span>
<span class="normal">55</span>
<span class="normal">56</span>
<span class="normal">57</span>
<span class="normal">58</span>
<span class="normal">59</span>
<span class="normal">60</span>
<span class="normal">61</span>
<span class="normal">62</span>
<span class="normal">63</span>
<span class="normal">64</span>
<span class="normal">65</span>
<span class="normal">66</span>
<span class="normal">67</span>
<span class="normal">68</span>
<span class="normal">69</span>
<span class="normal">70</span>
<span class="normal">71</span>
<span class="normal">72</span>
<span class="normal">73</span>
<span class="normal">74</span>
<span class="normal">75</span>
<span class="normal">76</span>
<span class="normal">77</span>
<span class="normal">78</span>
<span class="normal">79</span>
<span class="normal">80</span>
<span class="normal">81</span>
<span class="normal">82</span>
<span class="normal">83</span>
<span class="normal">84</span>
<span class="normal">85</span>
<span class="normal">86</span>
<span class="normal">87</span>
<span class="normal">88</span>
<span class="normal">89</span>
<span class="normal">90</span>
<span class="normal">91</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">clean_romance_synopsis</span><span class="p">(</span><span class="n">input_csv</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">output_csv</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Cleans a CSV file containing romance movie synopses by removing rows with missing data</span>
<span class="sd">    and processing the summaries column. The cleaned data is saved to an Excel file.</span>

<span class="sd">    Args:</span>
<span class="sd">        input_csv (str): Path to the input CSV file containing the full movie data.</span>
<span class="sd">                         Default is &quot;imdb_data/romance_newbatch.csv&quot;.</span>
<span class="sd">        output_csv (str): Path to the output CSV file where the cleaned data will be saved.</span>
<span class="sd">                            Default is &quot;imdb_data/romance_full_cleaned.csv&quot;.</span>

<span class="sd">    Returns:</span>
<span class="sd">        None</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">if</span> <span class="n">input_csv</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">input_csv</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;imdb_data/</span><span class="si">{</span><span class="n">OUTPUT_FILE</span><span class="si">}</span><span class="s2">&quot;</span>
    <span class="k">if</span> <span class="n">output_csv</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">output_csv</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;imdb_data/</span><span class="si">{</span><span class="n">CLEANED_OUTPUT_FILE</span><span class="si">}</span><span class="s2">&quot;</span>

    <span class="c1"># Load the input CSV file into a pandas DataFrame.</span>
    <span class="n">df</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">input_csv</span><span class="p">)</span>

    <span class="c1"># Filter out rows where all synopsis fields are missing or invalid.</span>
    <span class="n">original_len</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>
    <span class="n">condition</span> <span class="o">=</span> <span class="p">(</span>
        <span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;short_synopsis&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;No short sum found&#39;</span><span class="p">)</span> <span class="o">&amp;</span>
        <span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;long_synopsis&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;Synopsis not found&#39;</span><span class="p">)</span> <span class="o">&amp;</span>
        <span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;summaries&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">str</span><span class="p">)</span> <span class="o">==</span> <span class="s2">&quot;[&#39;No summaries found&#39;]&quot;</span><span class="p">)</span>
    <span class="p">)</span>
    <span class="n">df_cleaned</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="o">~</span><span class="n">condition</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="n">removed_count</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="n">original_len</span> <span class="o">-</span> <span class="nb">len</span><span class="p">(</span><span class="n">df_cleaned</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">clean_summary_list</span><span class="p">(</span><span class="n">summary_list</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span> <span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Union</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span> <span class="n">Any</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Cleans a list of summary strings by removing unwanted characters and truncating text.</span>

<span class="sd">        Args:</span>
<span class="sd">            summary_list (list or any): A list of summary strings to clean. If not a list, it is returned as-is.</span>

<span class="sd">        Returns:</span>
<span class="sd">            list or any: The cleaned list of summaries, or the original input if not a list.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">summary_list</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
            <span class="n">cleaned</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">summary_list</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
                    <span class="c1"># Remove unwanted characters or truncate text based on specific patterns.</span>
                    <span class="k">if</span> <span class="s1">&#39;_x0014_&#39;</span> <span class="ow">in</span> <span class="n">s</span><span class="p">:</span>
                        <span class="n">s</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;_x0014_&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
                    <span class="k">if</span> <span class="s1">&#39;—&#39;</span> <span class="ow">in</span> <span class="n">s</span><span class="p">:</span>
                        <span class="n">s</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">rsplit</span><span class="p">(</span><span class="s1">&#39;—&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
                <span class="n">cleaned</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">cleaned</span>
        <span class="k">return</span> <span class="n">summary_list</span>

    <span class="c1"># Parse string representations of lists into actual Python lists and clean them.</span>
    <span class="n">df_cleaned</span><span class="p">[</span><span class="s1">&#39;summaries&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df_cleaned</span><span class="p">[</span><span class="s1">&#39;summaries&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">ast</span><span class="o">.</span><span class="n">literal_eval</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span> <span class="k">else</span> <span class="n">x</span><span class="p">)</span>
    <span class="n">df_cleaned</span><span class="p">[</span><span class="s1">&#39;summaries&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df_cleaned</span><span class="p">[</span><span class="s1">&#39;summaries&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">clean_summary_list</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">remove_backslashes</span><span class="p">(</span><span class="n">text</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Any</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Removes backslashes from a string.</span>

<span class="sd">        Args:</span>
<span class="sd">            text (str or any): The input text to process. If not a string, it is returned as-is.</span>

<span class="sd">        Returns:</span>
<span class="sd">            str or any: The processed string with backslashes removed, or the original input if not a string.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">text</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">text</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\\</span><span class="s2">&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">text</span>

    <span class="c1"># Remove backslashes from the summaries column.</span>
    <span class="n">df_cleaned</span><span class="p">[</span><span class="s1">&#39;summaries&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df_cleaned</span><span class="p">[</span><span class="s1">&#39;summaries&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">remove_backslashes</span><span class="p">)</span>

    <span class="c1"># Save the cleaned DataFrame to an CSV file.</span>
    <span class="n">df_cleaned</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">output_csv</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;- Cleaned synopsis saved to: </span><span class="si">{</span><span class="n">output_csv</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;- Rows removed: </span><span class="si">{</span><span class="n">removed_count</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
          </details>
  </div>

</div>



  </div>

  </div>

</div>

<div class="doc doc-object doc-module">



<a id="app.pipeline.split_movie_data"></a>
  <div class="doc doc-contents first">

  

  <div class="doc doc-children">










<div class="doc doc-object doc-function">




<h2 id="app.pipeline.split_movie_data.split_movie_xlsx" class="doc doc-heading">
          <code class="highlight language-python"><span class="n">split_movie_xlsx</span><span class="p">(</span><span class="n">input_csv</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">output_dir</span><span class="o">=</span><span class="s1">&#39;imdb_data&#39;</span><span class="p">)</span></code>

</h2>


  <div class="doc doc-contents ">
  
      <p>Splits an XLSX file containing movie data into two separate files:
one for metadata and another for synopsis.</p>



  <p><strong>Parameters:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Name</th>
        <th>Type</th>
        <th>Description</th>
        <th>Default</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td><code>input_csv</code></td>
          <td>
                <code>str</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>Path to the input CSV file containing movie data.</p>
            </div>
          </td>
          <td>
                <code>None</code>
          </td>
        </tr>
        <tr>
          <td><code>output_dir</code></td>
          <td>
                <code>str</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>Directory where the output files will be saved.
              Defaults to "imdb_data".</p>
            </div>
          </td>
          <td>
                <code>&#39;imdb_data&#39;</code>
          </td>
        </tr>
    </tbody>
  </table>



  <p><strong>Returns:</strong></p>
  <table>
    <thead>
      <tr>
<th>Name</th>        <th>Type</th>
        <th>Description</th>
      </tr>
    </thead>
    <tbody>
        <tr>
<td><code>tuple</code></td>          <td>
          </td>
          <td>
            <div class="doc-md-description">
              <p>A tuple containing the paths to the metadata and synopsis files.
   (metadata_path, synopsis_path)</p>
            </div>
          </td>
        </tr>
    </tbody>
  </table>

          <details class="quote">
            <summary>Source code in <code>app/pipeline/split_movie_data.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span>
<span class="normal">17</span>
<span class="normal">18</span>
<span class="normal">19</span>
<span class="normal">20</span>
<span class="normal">21</span>
<span class="normal">22</span>
<span class="normal">23</span>
<span class="normal">24</span>
<span class="normal">25</span>
<span class="normal">26</span>
<span class="normal">27</span>
<span class="normal">28</span>
<span class="normal">29</span>
<span class="normal">30</span>
<span class="normal">31</span>
<span class="normal">32</span>
<span class="normal">33</span>
<span class="normal">34</span>
<span class="normal">35</span>
<span class="normal">36</span>
<span class="normal">37</span>
<span class="normal">38</span>
<span class="normal">39</span>
<span class="normal">40</span>
<span class="normal">41</span>
<span class="normal">42</span>
<span class="normal">43</span>
<span class="normal">44</span>
<span class="normal">45</span>
<span class="normal">46</span>
<span class="normal">47</span>
<span class="normal">48</span>
<span class="normal">49</span>
<span class="normal">50</span>
<span class="normal">51</span>
<span class="normal">52</span>
<span class="normal">53</span>
<span class="normal">54</span>
<span class="normal">55</span>
<span class="normal">56</span>
<span class="normal">57</span>
<span class="normal">58</span>
<span class="normal">59</span>
<span class="normal">60</span>
<span class="normal">61</span>
<span class="normal">62</span>
<span class="normal">63</span>
<span class="normal">64</span>
<span class="normal">65</span>
<span class="normal">66</span>
<span class="normal">67</span>
<span class="normal">68</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">split_movie_xlsx</span><span class="p">(</span><span class="n">input_csv</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">output_dir</span><span class="o">=</span><span class="s2">&quot;imdb_data&quot;</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Splits an XLSX file containing movie data into two separate files:</span>
<span class="sd">    one for metadata and another for synopsis.</span>

<span class="sd">    Args:</span>
<span class="sd">        input_csv (str): Path to the input CSV file containing movie data.</span>
<span class="sd">        output_dir (str): Directory where the output files will be saved.</span>
<span class="sd">                          Defaults to &quot;imdb_data&quot;.</span>

<span class="sd">    Returns:</span>
<span class="sd">        tuple: A tuple containing the paths to the metadata and synopsis files.</span>
<span class="sd">               (metadata_path, synopsis_path)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">input_csv</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">input_csv</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">output_dir</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">CLEANED_OUTPUT_FILE</span><span class="si">}</span><span class="s2">&quot;</span>
    <span class="c1"># Read the input CSV file into a DataFrame</span>
    <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">input_csv</span><span class="p">)</span>

    <span class="c1"># Define the columns to be included in the metadata file</span>
    <span class="n">metadata_cols</span> <span class="o">=</span> <span class="p">[</span>
        <span class="s1">&#39;tconst&#39;</span><span class="p">,</span>          <span class="c1"># Unique identifier for the movie</span>
        <span class="s1">&#39;movie_title&#39;</span><span class="p">,</span>     <span class="c1"># Title of the movie</span>
        <span class="s1">&#39;movie_year&#39;</span><span class="p">,</span>      <span class="c1"># Release year of the movie</span>
        <span class="s1">&#39;age_rating&#39;</span><span class="p">,</span>      <span class="c1"># Age rating of the movie</span>
        <span class="s1">&#39;duration&#39;</span><span class="p">,</span>        <span class="c1"># Duration of the movie</span>
        <span class="s1">&#39;imdb_rating&#39;</span><span class="p">,</span>     <span class="c1"># IMDb rating of the movie</span>
        <span class="s1">&#39;top_5_actors&#39;</span><span class="p">,</span>    <span class="c1"># List of top 5 actors in the movie</span>
        <span class="s1">&#39;poster_url&#39;</span>       <span class="c1"># URL of the movie&#39;s poster</span>
    <span class="p">]</span>

    <span class="c1"># Define the columns to be included in the synopsis file</span>
    <span class="n">synopsis_cols</span> <span class="o">=</span> <span class="p">[</span>
        <span class="s1">&#39;tconst&#39;</span><span class="p">,</span>          <span class="c1"># Unique identifier for the movie</span>
        <span class="s1">&#39;genres&#39;</span><span class="p">,</span>          <span class="c1"># List of genres associated with the movie</span>
        <span class="s1">&#39;short_synopsis&#39;</span><span class="p">,</span>  <span class="c1"># Short synopsis of the movie</span>
        <span class="s1">&#39;summaries&#39;</span><span class="p">,</span>       <span class="c1"># List of summaries for the movie</span>
        <span class="s1">&#39;long_synopsis&#39;</span>    <span class="c1"># Detailed synopsis of the movie</span>
    <span class="p">]</span>

    <span class="c1"># Create separate DataFrames for metadata and synopsis</span>
    <span class="n">metadata_df</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">metadata_cols</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="n">synopsis_df</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">synopsis_cols</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

    <span class="c1"># Define the output file paths</span>
    <span class="n">metadata_path</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">output_dir</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">MOVIE_METADATA_FILE</span><span class="si">}</span><span class="s2">&quot;</span>
    <span class="n">synopsis_path</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">output_dir</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">MOVIE_SYNOPSIS_FILE</span><span class="si">}</span><span class="s2">&quot;</span>

    <span class="c1"># Save the metadata DataFrame to an Excel file</span>
    <span class="n">metadata_df</span><span class="o">.</span><span class="n">to_excel</span><span class="p">(</span><span class="n">metadata_path</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

    <span class="c1"># Save the synopsis DataFrame to a CSV file</span>
    <span class="n">synopsis_df</span><span class="o">.</span><span class="n">to_excel</span><span class="p">(</span><span class="n">synopsis_path</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

    <span class="c1"># Log the paths of the saved files</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;- Saved metadata to: </span><span class="si">{</span><span class="n">metadata_path</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;- Saved synopsis to: </span><span class="si">{</span><span class="n">synopsis_path</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="c1"># Return the paths of the saved files</span>
    <span class="k">return</span> <span class="n">metadata_path</span><span class="p">,</span> <span class="n">synopsis_path</span>
</code></pre></div></td></tr></table></div>
          </details>
  </div>

</div>



  </div>

  </div>

</div>

<div class="doc doc-object doc-module">



<a id="app.pipeline.drive_upload"></a>
  <div class="doc doc-contents first">

  

  <div class="doc doc-children">










<div class="doc doc-object doc-function">




<h2 id="app.pipeline.drive_upload.upload_metadata_to_drive" class="doc doc-heading">
          <code class="highlight language-python"><span class="n">upload_metadata_to_drive</span><span class="p">(</span><span class="n">file_path</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">file_name</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>

</h2>


  <div class="doc doc-contents ">
  
      <p>Uploads a metadata file to Google Drive.</p>



  <p><strong>Parameters:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Name</th>
        <th>Type</th>
        <th>Description</th>
        <th>Default</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td><code>file_path</code></td>
          <td>
                <code>str</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>The local path to the file to be uploaded.
             Default is "imdb_data/romance_metadata.xlsx".</p>
            </div>
          </td>
          <td>
                <code>None</code>
          </td>
        </tr>
        <tr>
          <td><code>file_name</code></td>
          <td>
                <code>str</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>The name of the file as it will appear in Google Drive.
             Default is "romance_metadata.xlsx".</p>
            </div>
          </td>
          <td>
                <code>None</code>
          </td>
        </tr>
    </tbody>
  </table>



  <p><strong>Returns:</strong></p>
  <table>
    <thead>
      <tr>
<th>Name</th>        <th>Type</th>
        <th>Description</th>
      </tr>
    </thead>
    <tbody>
        <tr>
<td><code>str</code></td>          <td>
                <code>str</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>The ID of the uploaded file in Google Drive.</p>
            </div>
          </td>
        </tr>
    </tbody>
  </table>

          <details class="quote">
            <summary>Source code in <code>app/pipeline/drive_upload.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span>
<span class="normal">17</span>
<span class="normal">18</span>
<span class="normal">19</span>
<span class="normal">20</span>
<span class="normal">21</span>
<span class="normal">22</span>
<span class="normal">23</span>
<span class="normal">24</span>
<span class="normal">25</span>
<span class="normal">26</span>
<span class="normal">27</span>
<span class="normal">28</span>
<span class="normal">29</span>
<span class="normal">30</span>
<span class="normal">31</span>
<span class="normal">32</span>
<span class="normal">33</span>
<span class="normal">34</span>
<span class="normal">35</span>
<span class="normal">36</span>
<span class="normal">37</span>
<span class="normal">38</span>
<span class="normal">39</span>
<span class="normal">40</span>
<span class="normal">41</span>
<span class="normal">42</span>
<span class="normal">43</span>
<span class="normal">44</span>
<span class="normal">45</span>
<span class="normal">46</span>
<span class="normal">47</span>
<span class="normal">48</span>
<span class="normal">49</span>
<span class="normal">50</span>
<span class="normal">51</span>
<span class="normal">52</span>
<span class="normal">53</span>
<span class="normal">54</span>
<span class="normal">55</span>
<span class="normal">56</span>
<span class="normal">57</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">upload_metadata_to_drive</span><span class="p">(</span><span class="n">file_path</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">file_name</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>

<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Uploads a metadata file to Google Drive.</span>

<span class="sd">    Args:</span>
<span class="sd">        file_path (str): The local path to the file to be uploaded.</span>
<span class="sd">                         Default is &quot;imdb_data/romance_metadata.xlsx&quot;.</span>
<span class="sd">        file_name (str): The name of the file as it will appear in Google Drive.</span>
<span class="sd">                         Default is &quot;romance_metadata.xlsx&quot;.</span>

<span class="sd">    Returns:</span>
<span class="sd">        str: The ID of the uploaded file in Google Drive.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">file_path</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">file_path</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;imdb_data/</span><span class="si">{</span><span class="n">MOVIE_METADATA_FILE</span><span class="si">}</span><span class="s2">&quot;</span>
    <span class="k">if</span> <span class="n">file_name</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">file_name</span> <span class="o">=</span> <span class="n">MOVIE_METADATA_FILE</span>

    <span class="c1"># Define the MIME type for an Excel file.</span>
    <span class="n">mime_type</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;application/vnd.openxmlformats-officedocument.spreadsheetml.sheet&#39;</span>

    <span class="c1"># Authenticate using the service account credentials and the specified scopes.</span>
    <span class="n">credentials</span> <span class="o">=</span> <span class="n">service_account</span><span class="o">.</span><span class="n">Credentials</span><span class="o">.</span><span class="n">from_service_account_file</span><span class="p">(</span>
        <span class="n">SERVICE_ACCOUNT_FILE</span><span class="p">,</span> <span class="n">scopes</span><span class="o">=</span><span class="n">SCOPES</span><span class="p">)</span>
    <span class="n">service</span> <span class="o">=</span> <span class="n">build</span><span class="p">(</span><span class="s1">&#39;drive&#39;</span><span class="p">,</span> <span class="s1">&#39;v3&#39;</span><span class="p">,</span> <span class="n">credentials</span><span class="o">=</span><span class="n">credentials</span><span class="p">)</span>

    <span class="c1"># Define the metadata for the file to be uploaded, including its name and parent folder ID.</span>
    <span class="n">file_metadata</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="n">file_name</span><span class="p">,</span>
        <span class="s1">&#39;parents&#39;</span><span class="p">:</span> <span class="p">[</span><span class="n">FOLDER_ID</span><span class="p">]</span>
    <span class="p">}</span>

    <span class="c1"># Create a MediaFileUpload object to handle the file upload.</span>
    <span class="n">media</span> <span class="o">=</span> <span class="n">MediaFileUpload</span><span class="p">(</span><span class="n">file_path</span><span class="p">,</span> <span class="n">mimetype</span><span class="o">=</span><span class="n">mime_type</span><span class="p">)</span>

    <span class="c1"># Upload the file to Google Drive and retrieve the response containing the file ID.</span>
    <span class="n">response</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">=</span> <span class="n">service</span><span class="o">.</span><span class="n">files</span><span class="p">()</span><span class="o">.</span><span class="n">create</span><span class="p">(</span>
        <span class="n">body</span><span class="o">=</span><span class="n">file_metadata</span><span class="p">,</span>
        <span class="n">media_body</span><span class="o">=</span><span class="n">media</span><span class="p">,</span>
        <span class="n">fields</span><span class="o">=</span><span class="s1">&#39;id&#39;</span>
    <span class="p">)</span><span class="o">.</span><span class="n">execute</span><span class="p">()</span>

    <span class="c1"># Extract the file ID from the response and log the upload success.</span>
    <span class="n">file_id</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;id&quot;</span><span class="p">)</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;- Uploaded &#39;</span><span class="si">{</span><span class="n">file_name</span><span class="si">}</span><span class="s2">&#39; with file ID: </span><span class="si">{</span><span class="n">file_id</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">file_id</span>
</code></pre></div></td></tr></table></div>
          </details>
  </div>

</div>



  </div>

  </div>

</div>

<div class="doc doc-object doc-module">



<a id="app.pipeline.bigquery_upload"></a>
  <div class="doc doc-contents first">

  

  <div class="doc doc-children">










<div class="doc doc-object doc-function">




<h2 id="app.pipeline.bigquery_upload.upload_single_file_to_bigquery" class="doc doc-heading">
          <code class="highlight language-python"><span class="n">upload_single_file_to_bigquery</span><span class="p">(</span><span class="n">target_file_name</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">folder_id</span><span class="o">=</span><span class="s1">&#39;1sJcfq2h5NCOO2DNz2RxeIgSq-HYhl9Kg&#39;</span><span class="p">,</span> <span class="n">dataset_id</span><span class="o">=</span><span class="s1">&#39;romance_dataset&#39;</span><span class="p">,</span> <span class="n">table_name</span><span class="o">=</span><span class="s1">&#39;full_data_table&#39;</span><span class="p">)</span></code>

</h2>


  <div class="doc doc-contents ">
  
      <p>Uploads a single Excel file from Google Drive to a BigQuery table.</p>



  <p><strong>Parameters:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Name</th>
        <th>Type</th>
        <th>Description</th>
        <th>Default</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td><code>target_file_name</code></td>
          <td>
                <code>str</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>The name of the target Excel file to search for in Google Drive.</p>
            </div>
          </td>
          <td>
                <code>None</code>
          </td>
        </tr>
        <tr>
          <td><code>folder_id</code></td>
          <td>
                <code>str</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>The ID of the Google Drive folder containing the file.</p>
            </div>
          </td>
          <td>
                <code>&#39;1sJcfq2h5NCOO2DNz2RxeIgSq-HYhl9Kg&#39;</code>
          </td>
        </tr>
        <tr>
          <td><code>dataset_id</code></td>
          <td>
                <code>str</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>The ID of the BigQuery dataset where the table resides.</p>
            </div>
          </td>
          <td>
                <code>&#39;romance_dataset&#39;</code>
          </td>
        </tr>
        <tr>
          <td><code>table_name</code></td>
          <td>
                <code>str</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>The name of the BigQuery table to upload data to.</p>
            </div>
          </td>
          <td>
                <code>&#39;full_data_table&#39;</code>
          </td>
        </tr>
    </tbody>
  </table>



  <p><strong>Returns:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Type</th>
        <th>Description</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td>
                <code><span title="typing.Optional">Optional</span>[None]</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>None</p>
            </div>
          </td>
        </tr>
    </tbody>
  </table>

          <details class="quote">
            <summary>Source code in <code>app/pipeline/bigquery_upload.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 45</span>
<span class="normal"> 46</span>
<span class="normal"> 47</span>
<span class="normal"> 48</span>
<span class="normal"> 49</span>
<span class="normal"> 50</span>
<span class="normal"> 51</span>
<span class="normal"> 52</span>
<span class="normal"> 53</span>
<span class="normal"> 54</span>
<span class="normal"> 55</span>
<span class="normal"> 56</span>
<span class="normal"> 57</span>
<span class="normal"> 58</span>
<span class="normal"> 59</span>
<span class="normal"> 60</span>
<span class="normal"> 61</span>
<span class="normal"> 62</span>
<span class="normal"> 63</span>
<span class="normal"> 64</span>
<span class="normal"> 65</span>
<span class="normal"> 66</span>
<span class="normal"> 67</span>
<span class="normal"> 68</span>
<span class="normal"> 69</span>
<span class="normal"> 70</span>
<span class="normal"> 71</span>
<span class="normal"> 72</span>
<span class="normal"> 73</span>
<span class="normal"> 74</span>
<span class="normal"> 75</span>
<span class="normal"> 76</span>
<span class="normal"> 77</span>
<span class="normal"> 78</span>
<span class="normal"> 79</span>
<span class="normal"> 80</span>
<span class="normal"> 81</span>
<span class="normal"> 82</span>
<span class="normal"> 83</span>
<span class="normal"> 84</span>
<span class="normal"> 85</span>
<span class="normal"> 86</span>
<span class="normal"> 87</span>
<span class="normal"> 88</span>
<span class="normal"> 89</span>
<span class="normal"> 90</span>
<span class="normal"> 91</span>
<span class="normal"> 92</span>
<span class="normal"> 93</span>
<span class="normal"> 94</span>
<span class="normal"> 95</span>
<span class="normal"> 96</span>
<span class="normal"> 97</span>
<span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span>
<span class="normal">102</span>
<span class="normal">103</span>
<span class="normal">104</span>
<span class="normal">105</span>
<span class="normal">106</span>
<span class="normal">107</span>
<span class="normal">108</span>
<span class="normal">109</span>
<span class="normal">110</span>
<span class="normal">111</span>
<span class="normal">112</span>
<span class="normal">113</span>
<span class="normal">114</span>
<span class="normal">115</span>
<span class="normal">116</span>
<span class="normal">117</span>
<span class="normal">118</span>
<span class="normal">119</span>
<span class="normal">120</span>
<span class="normal">121</span>
<span class="normal">122</span>
<span class="normal">123</span>
<span class="normal">124</span>
<span class="normal">125</span>
<span class="normal">126</span>
<span class="normal">127</span>
<span class="normal">128</span>
<span class="normal">129</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">upload_single_file_to_bigquery</span><span class="p">(</span>
    <span class="n">target_file_name</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">folder_id</span><span class="o">=</span><span class="s2">&quot;1sJcfq2h5NCOO2DNz2RxeIgSq-HYhl9Kg&quot;</span><span class="p">,</span>
    <span class="n">dataset_id</span><span class="o">=</span><span class="s2">&quot;romance_dataset&quot;</span><span class="p">,</span>
    <span class="n">table_name</span><span class="o">=</span><span class="s2">&quot;full_data_table&quot;</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="kc">None</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Uploads a single Excel file from Google Drive to a BigQuery table.</span>

<span class="sd">    Args:</span>
<span class="sd">        target_file_name (str): The name of the target Excel file to search for in Google Drive.</span>
<span class="sd">        folder_id (str): The ID of the Google Drive folder containing the file.</span>
<span class="sd">        dataset_id (str): The ID of the BigQuery dataset where the table resides.</span>
<span class="sd">        table_name (str): The name of the BigQuery table to upload data to.</span>

<span class="sd">    Returns:</span>
<span class="sd">        None</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">target_file_name</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">target_file_name</span> <span class="o">=</span> <span class="n">MOVIE_METADATA_FILE</span>

    <span class="c1"># Query Google Drive for the file with the specified name and MIME type in the given folder.</span>
    <span class="n">query</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;&#39;</span><span class="si">{</span><span class="n">folder_id</span><span class="si">}</span><span class="s2">&#39; in parents and name=&#39;</span><span class="si">{</span><span class="n">target_file_name</span><span class="si">}</span><span class="s2">&#39; and mimeType=&#39;application/vnd.openxmlformats-officedocument.spreadsheetml.sheet&#39;&quot;</span>
    <span class="n">results</span> <span class="o">=</span> <span class="n">drive_service</span><span class="o">.</span><span class="n">files</span><span class="p">()</span><span class="o">.</span><span class="n">list</span><span class="p">(</span><span class="n">q</span><span class="o">=</span><span class="n">query</span><span class="p">,</span> <span class="n">fields</span><span class="o">=</span><span class="s2">&quot;files(id, name)&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">execute</span><span class="p">()</span>
    <span class="n">files</span> <span class="o">=</span> <span class="n">results</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;files&#39;</span><span class="p">,</span> <span class="p">[])</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">files</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;- File &#39;</span><span class="si">{</span><span class="n">target_file_name</span><span class="si">}</span><span class="s2">&#39; not found in folder.&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">None</span>

    <span class="n">file</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">=</span> <span class="n">files</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">file_id</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">file</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">]</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;- Found file: </span><span class="si">{</span><span class="n">file</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2"> (ID: </span><span class="si">{</span><span class="n">file_id</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>

    <span class="c1"># Use the Google Drive API to download the file content into a memory buffer.</span>
    <span class="n">request</span> <span class="o">=</span> <span class="n">drive_service</span><span class="o">.</span><span class="n">files</span><span class="p">()</span><span class="o">.</span><span class="n">get_media</span><span class="p">(</span><span class="n">fileId</span><span class="o">=</span><span class="n">file_id</span><span class="p">)</span>
    <span class="n">file_stream</span> <span class="o">=</span> <span class="n">io</span><span class="o">.</span><span class="n">BytesIO</span><span class="p">()</span>
    <span class="n">downloader</span> <span class="o">=</span> <span class="n">MediaIoBaseDownload</span><span class="p">(</span><span class="n">file_stream</span><span class="p">,</span> <span class="n">request</span><span class="p">)</span>
    <span class="n">done</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="k">while</span> <span class="ow">not</span> <span class="n">done</span><span class="p">:</span>
        <span class="n">status</span><span class="p">,</span> <span class="n">done</span> <span class="o">=</span> <span class="n">downloader</span><span class="o">.</span><span class="n">next_chunk</span><span class="p">()</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;- Download </span><span class="si">{</span><span class="nb">int</span><span class="p">(</span><span class="n">status</span><span class="o">.</span><span class="n">progress</span><span class="p">()</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">100</span><span class="p">)</span><span class="si">}</span><span class="s2">% complete.&quot;</span><span class="p">)</span>
    <span class="n">file_stream</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>

    <span class="c1"># Read the Excel file into a pandas DataFrame and remove duplicate rows based on the &quot;tconst&quot; column.</span>
    <span class="n">xls</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">ExcelFile</span><span class="p">(</span><span class="n">file_stream</span><span class="p">)</span>
    <span class="n">df</span> <span class="o">=</span> <span class="n">xls</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="n">xls</span><span class="o">.</span><span class="n">sheet_names</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">drop_duplicates</span><span class="p">(</span><span class="n">subset</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;tconst&quot;</span><span class="p">])</span>  <span class="c1"># Remove internal duplicates</span>

    <span class="c1"># Query the BigQuery table for existing rows and filter them out from the DataFrame.</span>
    <span class="n">full_table_id</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">bq_client</span><span class="o">.</span><span class="n">project</span><span class="si">}</span><span class="s2">.</span><span class="si">{</span><span class="n">dataset_id</span><span class="si">}</span><span class="s2">.</span><span class="si">{</span><span class="n">table_name</span><span class="si">}</span><span class="s2">&quot;</span>
    <span class="n">query</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;SELECT tconst FROM </span><span class="si">{</span><span class="n">full_table_id</span><span class="si">}</span><span class="s2">&quot;</span>
    <span class="n">existing</span> <span class="o">=</span> <span class="n">bq_client</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">query</span><span class="p">)</span><span class="o">.</span><span class="n">to_dataframe</span><span class="p">()</span>
    <span class="n">existing_set</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">existing</span><span class="p">[</span><span class="s1">&#39;tconst&#39;</span><span class="p">])</span>

    <span class="n">original_len</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>
    <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="o">~</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;tconst&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">existing_set</span><span class="p">)]</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;- Removed </span><span class="si">{</span><span class="n">original_len</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="p">)</span><span class="si">}</span><span class="s2"> rows already in BigQuery.&quot;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">df</span><span class="o">.</span><span class="n">empty</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;- No new rows to upload.&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">None</span>

    <span class="c1"># Add a &quot;staging_raw_id&quot; column to the DataFrame if it does not already exist.</span>
    <span class="k">if</span> <span class="s2">&quot;staging_raw_id&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
        <span class="n">df</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;staging_raw_id&quot;</span><span class="p">,</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">))</span>

    <span class="c1"># Convert specific columns to string type to ensure compatibility with BigQuery schema.</span>
    <span class="n">columns_to_stringify</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;movie_year&#39;</span><span class="p">,</span> <span class="s1">&#39;imdb_rating&#39;</span><span class="p">]</span>

    <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">columns_to_stringify</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
            <span class="n">df</span><span class="p">[</span><span class="n">col</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">col</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">str</span><span class="p">)</span>

    <span class="c1"># Configure the BigQuery load job to append data to the table and upload the DataFrame.</span>
    <span class="n">job_config</span> <span class="o">=</span> <span class="n">bigquery</span><span class="o">.</span><span class="n">LoadJobConfig</span><span class="p">(</span>
        <span class="n">autodetect</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">write_disposition</span><span class="o">=</span><span class="n">bigquery</span><span class="o">.</span><span class="n">WriteDisposition</span><span class="o">.</span><span class="n">WRITE_APPEND</span>  <span class="c1"># Append new rows to the table</span>
    <span class="p">)</span>

    <span class="n">load_job</span> <span class="o">=</span> <span class="n">bq_client</span><span class="o">.</span><span class="n">load_table_from_dataframe</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">full_table_id</span><span class="p">,</span> <span class="n">job_config</span><span class="o">=</span><span class="n">job_config</span><span class="p">)</span>
    <span class="n">load_job</span><span class="o">.</span><span class="n">result</span><span class="p">()</span>  <span class="c1"># Wait for the job to complete</span>

    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;- Uploaded </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="p">)</span><span class="si">}</span><span class="s2"> new row(s) to BigQuery table </span><span class="si">{</span><span class="n">full_table_id</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="kc">None</span>
</code></pre></div></td></tr></table></div>
          </details>
  </div>

</div>



  </div>

  </div>

</div>

<div class="doc doc-object doc-module">



<a id="app.pipeline.chunk_and_embed"></a>
  <div class="doc doc-contents first">

  

  <div class="doc doc-children">










<div class="doc doc-object doc-function">




<h2 id="app.pipeline.chunk_and_embed.run_chunk_and_embed_pipeline" class="doc doc-heading">
          <code class="highlight language-python"><span class="n">run_chunk_and_embed_pipeline</span><span class="p">(</span><span class="n">input_excel</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">output_dir</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>

</h2>


  <div class="doc doc-contents ">
  
      <p>Processes an Excel file containing movie data, chunks text fields, embeds the chunks using a
SentenceTransformer model, and saves the results as JSON files.</p>



  <p><strong>Parameters:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Name</th>
        <th>Type</th>
        <th>Description</th>
        <th>Default</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td><code>input_excel</code></td>
          <td>
                <code>str</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>Path to the input Excel file containing movie data.
               Default is "imdb_data/romance_synopsis_cleaned.xlsx".</p>
            </div>
          </td>
          <td>
                <code>None</code>
          </td>
        </tr>
        <tr>
          <td><code>output_dir</code></td>
          <td>
                <code>str</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>Directory where the chunked JSON files will be saved.
              Default is "chunked_jsons/romance_chunks_json".</p>
            </div>
          </td>
          <td>
                <code>None</code>
          </td>
        </tr>
    </tbody>
  </table>



  <p><strong>Returns:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Type</th>
        <th>Description</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td>
                <code>None</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>None</p>
            </div>
          </td>
        </tr>
    </tbody>
  </table>

          <details class="quote">
            <summary>Source code in <code>app/pipeline/chunk_and_embed.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 14</span>
<span class="normal"> 15</span>
<span class="normal"> 16</span>
<span class="normal"> 17</span>
<span class="normal"> 18</span>
<span class="normal"> 19</span>
<span class="normal"> 20</span>
<span class="normal"> 21</span>
<span class="normal"> 22</span>
<span class="normal"> 23</span>
<span class="normal"> 24</span>
<span class="normal"> 25</span>
<span class="normal"> 26</span>
<span class="normal"> 27</span>
<span class="normal"> 28</span>
<span class="normal"> 29</span>
<span class="normal"> 30</span>
<span class="normal"> 31</span>
<span class="normal"> 32</span>
<span class="normal"> 33</span>
<span class="normal"> 34</span>
<span class="normal"> 35</span>
<span class="normal"> 36</span>
<span class="normal"> 37</span>
<span class="normal"> 38</span>
<span class="normal"> 39</span>
<span class="normal"> 40</span>
<span class="normal"> 41</span>
<span class="normal"> 42</span>
<span class="normal"> 43</span>
<span class="normal"> 44</span>
<span class="normal"> 45</span>
<span class="normal"> 46</span>
<span class="normal"> 47</span>
<span class="normal"> 48</span>
<span class="normal"> 49</span>
<span class="normal"> 50</span>
<span class="normal"> 51</span>
<span class="normal"> 52</span>
<span class="normal"> 53</span>
<span class="normal"> 54</span>
<span class="normal"> 55</span>
<span class="normal"> 56</span>
<span class="normal"> 57</span>
<span class="normal"> 58</span>
<span class="normal"> 59</span>
<span class="normal"> 60</span>
<span class="normal"> 61</span>
<span class="normal"> 62</span>
<span class="normal"> 63</span>
<span class="normal"> 64</span>
<span class="normal"> 65</span>
<span class="normal"> 66</span>
<span class="normal"> 67</span>
<span class="normal"> 68</span>
<span class="normal"> 69</span>
<span class="normal"> 70</span>
<span class="normal"> 71</span>
<span class="normal"> 72</span>
<span class="normal"> 73</span>
<span class="normal"> 74</span>
<span class="normal"> 75</span>
<span class="normal"> 76</span>
<span class="normal"> 77</span>
<span class="normal"> 78</span>
<span class="normal"> 79</span>
<span class="normal"> 80</span>
<span class="normal"> 81</span>
<span class="normal"> 82</span>
<span class="normal"> 83</span>
<span class="normal"> 84</span>
<span class="normal"> 85</span>
<span class="normal"> 86</span>
<span class="normal"> 87</span>
<span class="normal"> 88</span>
<span class="normal"> 89</span>
<span class="normal"> 90</span>
<span class="normal"> 91</span>
<span class="normal"> 92</span>
<span class="normal"> 93</span>
<span class="normal"> 94</span>
<span class="normal"> 95</span>
<span class="normal"> 96</span>
<span class="normal"> 97</span>
<span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span>
<span class="normal">102</span>
<span class="normal">103</span>
<span class="normal">104</span>
<span class="normal">105</span>
<span class="normal">106</span>
<span class="normal">107</span>
<span class="normal">108</span>
<span class="normal">109</span>
<span class="normal">110</span>
<span class="normal">111</span>
<span class="normal">112</span>
<span class="normal">113</span>
<span class="normal">114</span>
<span class="normal">115</span>
<span class="normal">116</span>
<span class="normal">117</span>
<span class="normal">118</span>
<span class="normal">119</span>
<span class="normal">120</span>
<span class="normal">121</span>
<span class="normal">122</span>
<span class="normal">123</span>
<span class="normal">124</span>
<span class="normal">125</span>
<span class="normal">126</span>
<span class="normal">127</span>
<span class="normal">128</span>
<span class="normal">129</span>
<span class="normal">130</span>
<span class="normal">131</span>
<span class="normal">132</span>
<span class="normal">133</span>
<span class="normal">134</span>
<span class="normal">135</span>
<span class="normal">136</span>
<span class="normal">137</span>
<span class="normal">138</span>
<span class="normal">139</span>
<span class="normal">140</span>
<span class="normal">141</span>
<span class="normal">142</span>
<span class="normal">143</span>
<span class="normal">144</span>
<span class="normal">145</span>
<span class="normal">146</span>
<span class="normal">147</span>
<span class="normal">148</span>
<span class="normal">149</span>
<span class="normal">150</span>
<span class="normal">151</span>
<span class="normal">152</span>
<span class="normal">153</span>
<span class="normal">154</span>
<span class="normal">155</span>
<span class="normal">156</span>
<span class="normal">157</span>
<span class="normal">158</span>
<span class="normal">159</span>
<span class="normal">160</span>
<span class="normal">161</span>
<span class="normal">162</span>
<span class="normal">163</span>
<span class="normal">164</span>
<span class="normal">165</span>
<span class="normal">166</span>
<span class="normal">167</span>
<span class="normal">168</span>
<span class="normal">169</span>
<span class="normal">170</span>
<span class="normal">171</span>
<span class="normal">172</span>
<span class="normal">173</span>
<span class="normal">174</span>
<span class="normal">175</span>
<span class="normal">176</span>
<span class="normal">177</span>
<span class="normal">178</span>
<span class="normal">179</span>
<span class="normal">180</span>
<span class="normal">181</span>
<span class="normal">182</span>
<span class="normal">183</span>
<span class="normal">184</span>
<span class="normal">185</span>
<span class="normal">186</span>
<span class="normal">187</span>
<span class="normal">188</span>
<span class="normal">189</span>
<span class="normal">190</span>
<span class="normal">191</span>
<span class="normal">192</span>
<span class="normal">193</span>
<span class="normal">194</span>
<span class="normal">195</span>
<span class="normal">196</span>
<span class="normal">197</span>
<span class="normal">198</span>
<span class="normal">199</span>
<span class="normal">200</span>
<span class="normal">201</span>
<span class="normal">202</span>
<span class="normal">203</span>
<span class="normal">204</span>
<span class="normal">205</span>
<span class="normal">206</span>
<span class="normal">207</span>
<span class="normal">208</span>
<span class="normal">209</span>
<span class="normal">210</span>
<span class="normal">211</span>
<span class="normal">212</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">run_chunk_and_embed_pipeline</span><span class="p">(</span>
    <span class="n">input_excel</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">output_dir</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Processes an Excel file containing movie data, chunks text fields, embeds the chunks using a</span>
<span class="sd">    SentenceTransformer model, and saves the results as JSON files.</span>

<span class="sd">    Args:</span>
<span class="sd">        input_excel (str): Path to the input Excel file containing movie data.</span>
<span class="sd">                           Default is &quot;imdb_data/romance_synopsis_cleaned.xlsx&quot;.</span>
<span class="sd">        output_dir (str): Directory where the chunked JSON files will be saved.</span>
<span class="sd">                          Default is &quot;chunked_jsons/romance_chunks_json&quot;.</span>

<span class="sd">    Returns:</span>
<span class="sd">        None</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">input_excel</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">input_excel</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;imdb_data/</span><span class="si">{</span><span class="n">MOVIE_SYNOPSIS_FILE</span><span class="si">}</span><span class="s2">&quot;</span>
    <span class="k">if</span> <span class="n">output_dir</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">output_dir</span> <span class="o">=</span> <span class="n">JSONS_FOLDER</span>

    <span class="c1"># Load the SentenceTransformer model for embedding text.</span>
    <span class="n">model</span><span class="p">:</span> <span class="n">SentenceTransformer</span> <span class="o">=</span> <span class="n">SentenceTransformer</span><span class="p">(</span><span class="s1">&#39;bert-base-nli-mean-tokens&#39;</span><span class="p">)</span>
    <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">output_dir</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="c1"># Read the input Excel file into a pandas DataFrame.</span>
    <span class="n">df</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_excel</span><span class="p">(</span><span class="n">input_excel</span><span class="p">,</span> <span class="n">engine</span><span class="o">=</span><span class="s1">&#39;openpyxl&#39;</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">smart_split_sentences</span><span class="p">(</span><span class="n">text</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Splits a text into sentences while preserving abbreviations.</span>

<span class="sd">        Args:</span>
<span class="sd">            text (str): The input text to split.</span>

<span class="sd">        Returns:</span>
<span class="sd">            list: A list of sentences.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">abbreviations</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;Dr.&quot;</span><span class="p">:</span> <span class="s2">&quot;DR_ABBR&quot;</span><span class="p">,</span> <span class="s2">&quot;Mr.&quot;</span><span class="p">:</span> <span class="s2">&quot;MR_ABBR&quot;</span><span class="p">,</span> <span class="s2">&quot;Mrs.&quot;</span><span class="p">:</span> <span class="s2">&quot;MRS_ABBR&quot;</span><span class="p">,</span> <span class="s2">&quot;Ms.&quot;</span><span class="p">:</span> <span class="s2">&quot;MS_ABBR&quot;</span><span class="p">,</span>
            <span class="s2">&quot;Jr.&quot;</span><span class="p">:</span> <span class="s2">&quot;JR_ABBR&quot;</span><span class="p">,</span> <span class="s2">&quot;Sr.&quot;</span><span class="p">:</span> <span class="s2">&quot;SR_ABBR&quot;</span><span class="p">,</span> <span class="s2">&quot;St.&quot;</span><span class="p">:</span> <span class="s2">&quot;ST_ABBR&quot;</span><span class="p">,</span> <span class="s2">&quot;Prof.&quot;</span><span class="p">:</span> <span class="s2">&quot;PROF_ABBR&quot;</span><span class="p">,</span>
            <span class="s2">&quot;Inc.&quot;</span><span class="p">:</span> <span class="s2">&quot;INC_ABBR&quot;</span><span class="p">,</span> <span class="s2">&quot;Ltd.&quot;</span><span class="p">:</span> <span class="s2">&quot;LTD_ABBR&quot;</span><span class="p">,</span> <span class="s2">&quot;vs.&quot;</span><span class="p">:</span> <span class="s2">&quot;VS_ABBR&quot;</span><span class="p">,</span>
            <span class="s2">&quot;e.g.&quot;</span><span class="p">:</span> <span class="s2">&quot;EG_ABBR&quot;</span><span class="p">,</span> <span class="s2">&quot;i.e.&quot;</span><span class="p">:</span> <span class="s2">&quot;IE_ABBR&quot;</span>
        <span class="p">}</span>
        <span class="k">for</span> <span class="n">abbr</span><span class="p">,</span> <span class="n">token</span> <span class="ow">in</span> <span class="n">abbreviations</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">text</span> <span class="o">=</span> <span class="n">text</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">abbr</span><span class="p">,</span> <span class="n">token</span><span class="p">)</span>
        <span class="n">sentences</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;(?&lt;=[.!?])\s+&#39;</span><span class="p">,</span> <span class="n">text</span><span class="p">)</span>
        <span class="n">restored</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">sentence</span> <span class="ow">in</span> <span class="n">sentences</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">abbr</span><span class="p">,</span> <span class="n">token</span> <span class="ow">in</span> <span class="n">abbreviations</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="n">sentence</span> <span class="o">=</span> <span class="n">sentence</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">token</span><span class="p">,</span> <span class="n">abbr</span><span class="p">)</span>
            <span class="n">restored</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">sentence</span><span class="o">.</span><span class="n">strip</span><span class="p">())</span>
        <span class="k">return</span> <span class="n">restored</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">chunk_text</span><span class="p">(</span><span class="n">text</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">min_chunk_size</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">100</span><span class="p">,</span> <span class="n">max_chunk_size</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">275</span><span class="p">,</span> <span class="n">target_chunk_size</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">240</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Splits a text into chunks of specified sizes.</span>

<span class="sd">        Args:</span>
<span class="sd">            text (str): The input text to chunk.</span>
<span class="sd">            min_chunk_size (int): Minimum size of a chunk in words. Default is 100.</span>
<span class="sd">            max_chunk_size (int): Maximum size of a chunk in words. Default is 275.</span>
<span class="sd">            target_chunk_size (int): Target size of a chunk in words. Default is 240.</span>

<span class="sd">        Returns:</span>
<span class="sd">            list: A list of text chunks.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">words</span> <span class="o">=</span> <span class="n">text</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">words</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="n">target_chunk_size</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">[</span><span class="n">text</span><span class="o">.</span><span class="n">strip</span><span class="p">()]</span>
        <span class="n">sentences</span> <span class="o">=</span> <span class="n">smart_split_sentences</span><span class="p">(</span><span class="n">text</span><span class="p">)</span>
        <span class="n">chunks</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">current_chunk</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">current_length</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">sentence</span> <span class="ow">in</span> <span class="n">sentences</span><span class="p">:</span>
            <span class="n">sentence_length</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">sentence</span><span class="o">.</span><span class="n">split</span><span class="p">())</span>
            <span class="k">if</span> <span class="n">current_length</span> <span class="o">+</span> <span class="n">sentence_length</span> <span class="o">&gt;</span> <span class="n">max_chunk_size</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">current_chunk</span><span class="p">:</span>
                    <span class="n">chunks</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">current_chunk</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">())</span>
                <span class="n">current_chunk</span> <span class="o">=</span> <span class="p">[</span><span class="n">sentence</span><span class="p">]</span>
                <span class="n">current_length</span> <span class="o">=</span> <span class="n">sentence_length</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">current_chunk</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">sentence</span><span class="p">)</span>
                <span class="n">current_length</span> <span class="o">+=</span> <span class="n">sentence_length</span>
        <span class="k">if</span> <span class="n">current_chunk</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">chunks</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">current_chunk</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">())</span> <span class="o">&lt;</span> <span class="n">min_chunk_size</span><span class="p">:</span>
                <span class="n">chunks</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+=</span> <span class="s2">&quot; &quot;</span> <span class="o">+</span> <span class="s2">&quot; &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">current_chunk</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">chunks</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">current_chunk</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">())</span>
        <span class="k">return</span> <span class="n">chunks</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">smart_split_summaries</span><span class="p">(</span><span class="n">text</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Splits a summary text into individual summaries.</span>

<span class="sd">        Args:</span>
<span class="sd">            text (str): The input summary text.</span>

<span class="sd">        Returns:</span>
<span class="sd">            list: A list of cleaned summary strings.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">text</span> <span class="o">=</span> <span class="n">text</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">text</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;[&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">text</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">&quot;]&quot;</span><span class="p">):</span>
            <span class="n">text</span> <span class="o">=</span> <span class="n">text</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">split_candidates</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;&quot;&quot;(?&lt;!\\)[&#39;&quot;]\s*,\s*[&#39;&quot;]&quot;&quot;&quot;</span><span class="p">,</span> <span class="n">text</span><span class="p">)</span>
        <span class="n">cleaned</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">chunk</span> <span class="ow">in</span> <span class="n">split_candidates</span><span class="p">:</span>
            <span class="n">chunk</span> <span class="o">=</span> <span class="n">chunk</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="s1">&#39;&quot;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="s2">&quot;&#39;&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">chunk</span> <span class="ow">and</span> <span class="n">chunk</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">!=</span> <span class="s2">&quot;no summaries found&quot;</span><span class="p">:</span>
                <span class="n">cleaned</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">chunk</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">cleaned</span>

    <span class="c1"># Initialize lists to store documents and text for embedding.</span>
    <span class="n">all_documents</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">dict</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">texts_to_embed</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="c1"># Iterate over each row in the DataFrame.</span>
    <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">iterrows</span><span class="p">():</span>
        <span class="n">movie_id</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="s2">&quot;tconst&quot;</span><span class="p">]</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">genres</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="nb">eval</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="s2">&quot;genres&quot;</span><span class="p">])</span> <span class="k">if</span> <span class="n">pd</span><span class="o">.</span><span class="n">notna</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="s2">&quot;genres&quot;</span><span class="p">])</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="s2">&quot;genres&quot;</span><span class="p">],</span> <span class="nb">str</span><span class="p">)</span> <span class="k">else</span> <span class="p">[]</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="n">genres</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">short_synopsis</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="s2">&quot;short_synopsis&quot;</span><span class="p">]</span> <span class="k">if</span> <span class="n">pd</span><span class="o">.</span><span class="n">notna</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="s2">&quot;short_synopsis&quot;</span><span class="p">])</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span>
        <span class="n">long_synopsis</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="s2">&quot;long_synopsis&quot;</span><span class="p">]</span> <span class="k">if</span> <span class="n">pd</span><span class="o">.</span><span class="n">notna</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="s2">&quot;long_synopsis&quot;</span><span class="p">])</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span>
        <span class="n">summaries</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="s2">&quot;summaries&quot;</span><span class="p">]</span>

        <span class="c1"># Process short synopsis if available.</span>
        <span class="k">if</span> <span class="n">short_synopsis</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="ow">and</span> <span class="n">short_synopsis</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="o">!=</span> <span class="s2">&quot;No short sum found&quot;</span><span class="p">:</span>
            <span class="n">doc</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s2">&quot;movie_id&quot;</span><span class="p">:</span> <span class="n">movie_id</span><span class="p">,</span>
                <span class="s2">&quot;genres&quot;</span><span class="p">:</span> <span class="n">genres</span><span class="p">,</span>
                <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;short&quot;</span><span class="p">,</span>
                <span class="s2">&quot;chunk_id&quot;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">movie_id</span><span class="si">}</span><span class="s2">-sh-1&quot;</span><span class="p">,</span>
                <span class="s2">&quot;text&quot;</span><span class="p">:</span> <span class="n">short_synopsis</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
            <span class="p">}</span>
            <span class="n">all_documents</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">doc</span><span class="p">)</span>
            <span class="n">texts_to_embed</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">doc</span><span class="p">[</span><span class="s2">&quot;text&quot;</span><span class="p">])</span>

        <span class="c1"># Process summaries if available.</span>
        <span class="k">if</span> <span class="n">pd</span><span class="o">.</span><span class="n">notna</span><span class="p">(</span><span class="n">summaries</span><span class="p">):</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">summaries</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
                <span class="n">summaries</span> <span class="o">=</span> <span class="n">smart_split_summaries</span><span class="p">(</span><span class="n">summaries</span><span class="p">)</span>
            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">summaries</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
                <span class="n">summaries</span> <span class="o">=</span> <span class="p">[</span><span class="n">s</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">summaries</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="nb">str</span><span class="p">)]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">summaries</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">summaries</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">for</span> <span class="n">j</span><span class="p">,</span> <span class="n">summary</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">summaries</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">summary</span><span class="o">.</span><span class="n">strip</span><span class="p">():</span>
                <span class="n">chunks</span> <span class="o">=</span> <span class="n">chunk_text</span><span class="p">(</span><span class="n">summary</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">chunk</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">chunks</span><span class="p">):</span>
                    <span class="n">doc</span> <span class="o">=</span> <span class="p">{</span>
                        <span class="s2">&quot;movie_id&quot;</span><span class="p">:</span> <span class="n">movie_id</span><span class="p">,</span>
                        <span class="s2">&quot;genres&quot;</span><span class="p">:</span> <span class="n">genres</span><span class="p">,</span>
                        <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;summary&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;chunk_id&quot;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">movie_id</span><span class="si">}</span><span class="s2">-summary-</span><span class="si">{</span><span class="n">j</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="si">}</span><span class="s2">-</span><span class="si">{</span><span class="n">i</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;text&quot;</span><span class="p">:</span> <span class="n">chunk</span>
                    <span class="p">}</span>
                    <span class="n">all_documents</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">doc</span><span class="p">)</span>
                    <span class="n">texts_to_embed</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">chunk</span><span class="p">)</span>

        <span class="c1"># Process long synopsis if available.</span>
        <span class="k">if</span> <span class="n">long_synopsis</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="ow">and</span> <span class="n">long_synopsis</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="o">!=</span> <span class="s2">&quot;Synopsis not found&quot;</span><span class="p">:</span>
            <span class="n">long_chunks</span> <span class="o">=</span> <span class="n">chunk_text</span><span class="p">(</span><span class="n">long_synopsis</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">chunk</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">long_chunks</span><span class="p">):</span>
                <span class="n">doc</span> <span class="o">=</span> <span class="p">{</span>
                    <span class="s2">&quot;movie_id&quot;</span><span class="p">:</span> <span class="n">movie_id</span><span class="p">,</span>
                    <span class="s2">&quot;genres&quot;</span><span class="p">:</span> <span class="n">genres</span><span class="p">,</span>
                    <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;long&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;chunk_id&quot;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">movie_id</span><span class="si">}</span><span class="s2">-lon-</span><span class="si">{</span><span class="n">i</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;text&quot;</span><span class="p">:</span> <span class="n">chunk</span>
                <span class="p">}</span>
                <span class="n">all_documents</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">doc</span><span class="p">)</span>
                <span class="n">texts_to_embed</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">chunk</span><span class="p">)</span>

        <span class="c1"># Embed the text chunks using the SentenceTransformer model.</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;- Embedding </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">texts_to_embed</span><span class="p">)</span><span class="si">}</span><span class="s2"> chunks on GPU...&quot;</span><span class="p">)</span>
        <span class="n">vectors</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="n">texts_to_embed</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="mi">32</span><span class="p">,</span> <span class="n">show_progress_bar</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="c1"># Add the embedding vectors to the corresponding documents.</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">vector</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">vectors</span><span class="p">):</span>
            <span class="n">all_documents</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s2">&quot;vector&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">vector</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>

        <span class="c1"># Save each document as a JSON file in the output directory.</span>
        <span class="k">for</span> <span class="n">doc</span> <span class="ow">in</span> <span class="n">all_documents</span><span class="p">:</span>
            <span class="n">filename</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">doc</span><span class="p">[</span><span class="s1">&#39;chunk_id&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">.json&quot;</span>
            <span class="n">path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">output_dir</span><span class="p">,</span> <span class="n">filename</span><span class="p">)</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s2">&quot;utf-8&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                <span class="n">json</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">doc</span><span class="p">,</span> <span class="n">f</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="mi">4</span><span class="p">)</span>

        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;- </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">all_documents</span><span class="p">)</span><span class="si">}</span><span class="s2"> documents saved to: </span><span class="si">{</span><span class="n">output_dir</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="c1"># Create a ZIP archive of the output directory.</span>
        <span class="n">shutil</span><span class="o">.</span><span class="n">make_archive</span><span class="p">(</span><span class="n">output_dir</span><span class="p">,</span> <span class="s1">&#39;zip&#39;</span><span class="p">,</span> <span class="n">output_dir</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;- Archive created: </span><span class="si">{</span><span class="n">output_dir</span><span class="si">}</span><span class="s2">.zip&quot;</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
          </details>
  </div>

</div>



  </div>

  </div>

</div>












                
              </article>
            </div>
          
          
  <script>var tabs=__md_get("__tabs");if(Array.isArray(tabs))e:for(var set of document.querySelectorAll(".tabbed-set")){var labels=set.querySelector(".tabbed-labels");for(var tab of tabs)for(var label of labels.getElementsByTagName("label"))if(label.innerText.trim()===tab){var input=document.getElementById(label.htmlFor);input.checked=!0;continue e}}</script>

<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
          <button type="button" class="md-top md-icon" data-md-component="top" hidden>
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8z"/></svg>
  Back to top
</button>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    
    
      
      <script id="__config" type="application/json">{"base": "..", "features": ["navigation.tabs", "navigation.sections", "toc.integrate", "navigation.top", "search.suggest", "search.highlight", "content.tabs.link", "content.code.annotation", "content.code.copy"], "search": "../assets/javascripts/workers/search.d50fe291.min.js", "tags": null, "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}, "version": null}</script>
    
    
      <script src="../assets/javascripts/bundle.13a4f30d.min.js"></script>
      
    
  </body>
</html>